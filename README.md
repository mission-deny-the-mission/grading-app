# Document Grading Web App

[![CI](https://gitea.harryslab.xyz/mission-deny-the-mission/grading-app/actions/workflows/ci.yml/badge.svg?branch=main)](https://gitea.harryslab.xyz/mission-deny-the-mission/grading-app/actions)

AI-powered document grading with support for OpenRouter, Claude API, and LM Studio. Features include structured grading schemes, batch processing, and comprehensive export capabilities.

**Security Update**: API keys are now encrypted at rest in the database using Fernet encryption.

## ‚ú® Features

- **AI-Powered Grading**: Integrate with multiple AI providers (OpenRouter, Claude, LM Studio)
- **Structured Grading Schemes**: Create reusable rubrics with hierarchical questions and criteria
- **Batch Processing**: Grade multiple submissions efficiently
- **Export & Analytics**: Export results in CSV/JSON formats with statistical analysis
- **Version Control**: Track scheme modifications and maintain historical grading data
- **Fractional Points**: Support for decimal point precision (e.g., 2.5 points)

## üîß Recent Updates

### Structured Grading Scheme System (NEW)
A comprehensive grading scheme system has been implemented, allowing educators to:
- Create hierarchical grading rubrics with questions and criteria
- Apply schemes to submissions for consistent grading
- Track usage statistics and export detailed reports
- Clone and version schemes for reusability

## üîß Setup & Configuration

### Quick Start

```bash
# 1. Install dependencies (includes cryptography>=41.0.0 for encryption)
pip install -r requirements.txt

# 2. Generate encryption key (REQUIRED for security)
python -c "from cryptography.fernet import Fernet; print(f'DB_ENCRYPTION_KEY={Fernet.generate_key().decode()}')"

# 3. Add key to .env file
# Copy the generated key above and add to .env:
# DB_ENCRYPTION_KEY=your_generated_key_here
# ‚ö†Ô∏è NEVER commit .env to version control

# 4. Start the application
python app.py
```

**Dependencies**:
- Python >=3.9
- Flask 2.3.3+
- cryptography >=41.0.0 (for API key encryption)
- Flask-Migrate >=4.0.0 (for database migrations)
- Additional dependencies listed in `requirements.txt`

### Encryption Key Setup (Critical for Production)

The application uses **Fernet symmetric encryption** (AES-128-CBC with HMAC-SHA256) for all stored API keys. A unique encryption key **MUST** be generated for each deployment:

```bash
# Generate a new encryption key
python -c "from cryptography.fernet import Fernet; key = Fernet.generate_key().decode(); print(f'DB_ENCRYPTION_KEY={key}')"

# Add to your .env file (do NOT commit to git):
echo "DB_ENCRYPTION_KEY=your_generated_key_here" >> .env

# Verify the key is loaded:
python -c "import os; from dotenv import load_dotenv; load_dotenv(); print('‚úÖ Key loaded' if os.getenv('DB_ENCRYPTION_KEY') else '‚ùå Key missing')"
```

**‚ö†Ô∏è Important Security Notes**:
- Store the `DB_ENCRYPTION_KEY` securely (environment variables, secrets manager, encrypted vault)
- **Never commit** the key or `.env` file to version control
- Use the same key across application restarts to decrypt stored keys
- Losing the key makes encrypted keys **permanently unrecoverable**
- Encryption key must be 32 base64-encoded bytes (automatically generated by Fernet)

**Environment Variables**:
```bash
# Required for API key encryption
DB_ENCRYPTION_KEY=<generated-fernet-key>

# Optional: Database configuration
DATABASE_URL=<database-connection-string>
```

### Production Migration (Existing Installations)

If upgrading an existing installation with plaintext API keys:

```bash
# 1. Backup your database before proceeding
# Example with SQLite:
cp grading_app.db grading_app.db.backup

# Example with PostgreSQL:
pg_dump grading_app > backup_before_migration.sql

# 2. Set DB_ENCRYPTION_KEY environment variable
export DB_ENCRYPTION_KEY=$(python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())")

# 3. Run the migration script to encrypt existing keys
python migrations/encrypt_api_keys.py

# 4. Verify keys are encrypted
# Check logs for "‚úÖ Migration complete!"

# 5. Start the application
python app.py

# 6. Test API key functionality on the configuration page
```

**Migration Rollback Plan**:
If migration fails, restore from backup:
```bash
# SQLite rollback:
cp grading_app.db.backup grading_app.db

# PostgreSQL rollback:
psql grading_app < backup_before_migration.sql
```

### Troubleshooting

**Issue: "DB_ENCRYPTION_KEY not set in environment"**
- Solution: Generate a key and add to `.env` file using instructions above
- Verify: Run `python -c "import os; from dotenv import load_dotenv; load_dotenv(); print(os.getenv('DB_ENCRYPTION_KEY'))"`

**Issue: "Decryption failed: InvalidToken"**
- Solution: Verify `DB_ENCRYPTION_KEY` matches the key used during encryption
- Recovery: If key is lost, API keys must be re-entered manually (encrypted keys are unrecoverable)

**Issue: "Invalid API key format" when saving configuration**
- Solution: Check that API key matches provider's expected format (see validation patterns below)
- Verify: Test key format with validation patterns in `utils/llm_providers.py`

**Issue: Application fails to start after encryption setup**
- Solution: Check application logs for specific error messages
- Verify: Ensure `cryptography` package is installed: `pip install cryptography>=41.0.0`

## Security Features

### API Key Encryption
All API keys are encrypted at rest using **Fernet encryption** (AES-128-CBC + HMAC-SHA256):
- Automatic encryption when saving configuration
- Transparent decryption when loading configuration
- Database stores only ciphertext, never plaintext keys
- Each save generates a new initialization vector (IV) for additional security

### API Key Validation
API keys are validated before storage:
- **Format validation**: Provider-specific regex patterns ensure keys match expected formats
- **Supported providers**:
  - OpenRouter: `sk-or-v1-[64 alphanumeric characters]`
  - Claude: `sk-ant-api03-[95 alphanumeric/hyphen/underscore characters]`
  - OpenAI: `sk-[48 alphanumeric characters]`
  - Gemini: `[39 alphanumeric/hyphen/underscore characters]`
  - Additional providers: NanoGPT, Chutes, Z.AI
  - Local providers (LM Studio, Ollama): Accept any value
- **Error handling**: Clear error messages with provider-specific remediation suggestions
- Empty keys are allowed (providers remain optional)

### Configuration Management
- **Real-time validation**: API key format validation occurs before database save
- **Encrypted storage**: All cloud API keys encrypted using Fernet symmetric encryption
- **Transparent operation**: Application automatically encrypts/decrypts without user intervention

## Quick Links

- Getting started: `docs/Getting-Started.md`
- Features overview: `docs/Features.md`
- Testing: `docs/Testing.md`
- Docker: `docs/Docker.md`
- Bulk upload tests: `tests/README_bulk_upload_tests.md`
<<<<<<< Updated upstream
- Security implementation: `specs/002-api-provider-security/quickstart.md`
- Security deployment guide: `specs/002-api-provider-security/deployment.md`
=======
- **Grading Schemes Guide**: `docs/grading-schemes/README.md`
>>>>>>> Stashed changes

## File structure

```
grading-app/
‚îú‚îÄ‚îÄ app.py
‚îú‚îÄ‚îÄ routes/
‚îú‚îÄ‚îÄ utils/
‚îú‚îÄ‚îÄ models.py
‚îú‚îÄ‚îÄ tasks.py
‚îú‚îÄ‚îÄ templates/
‚îú‚îÄ‚îÄ docs/
‚îú‚îÄ‚îÄ tests/
‚îú‚îÄ‚îÄ validate_bulk_upload_fix.py  # Quick validation script
‚îî‚îÄ‚îÄ uploads/
```

## License

MIT
