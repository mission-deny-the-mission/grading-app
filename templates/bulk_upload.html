{% extends "base.html" %} {% block title %}Bulk Upload{% endblock %} {% block
content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="text-center mb-4">
            <h1 class="display-4 fw-bold text-primary mb-3">
                <i class="fas fa-upload me-3"></i>
                Bulk Document Upload
            </h1>
            <p class="lead text-muted">
                Upload multiple documents and process them in the background
            </p>
        </div>

        <!-- Step 1: Job Configuration -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cog me-2"></i>Step 1: Configure Grading Job
                </h5>
            </div>
            <div class="card-body">
                <form id="jobForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="jobName" class="form-label fw-bold"
                                >Job Name</label
                            >
                            <input
                                type="text"
                                class="form-control"
                                id="jobName"
                                required
                            />
                            <div class="form-text">
                                Give your job a descriptive name
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="priority" class="form-label fw-bold"
                                >Priority</label
                            >
                            <select class="form-select" id="priority">
                                <option value="1">Low (1)</option>
                                <option value="3">Medium-Low (3)</option>
                                <option value="5" selected>Normal (5)</option>
                                <option value="7">Medium-High (7)</option>
                                <option value="10">High (10)</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="jobDescription" class="form-label fw-bold"
                            >Description (Optional)</label
                        >
                        <textarea
                            class="form-control"
                            id="jobDescription"
                            rows="2"
                            placeholder="Describe what this job is for..."
                        ></textarea>
                    </div>

                    <!-- Job Template Selection -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-layer-group me-2"></i>Job Template
                        </label>
                        <div class="d-flex align-items-center gap-2">
                            <select class="form-select" id="jobTemplateSelect">
                                <option value="">No template - Manual configuration</option>
                                {% for template in job_templates %}
                                <option value="{{ template.id }}">{{ template.name }}</option>
                                {% endfor %}
                            </select>
                            <button
                                type="button"
                                class="btn btn-outline-secondary btn-sm"
                                onclick="loadJobTemplate()"
                                id="loadTemplateBtn"
                            >
                                <i class="fas fa-download me-1"></i>Load Template
                            </button>
                        </div>
                        <div class="form-text">
                            Select a template to automatically populate job settings
                        </div>
                        <div
                            id="templateInfo"
                            class="alert alert-info mt-2"
                            style="display: none"
                        >
                            <i class="fas fa-info-circle me-2"></i>
                            <span id="templateInfoText"></span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="provider" class="form-label fw-bold">
                                <i class="fas fa-robot me-2"></i>AI Provider
                            </label>
                            <select class="form-select" id="provider" required>
                                <option value="openrouter">
                                    OpenRouter (Multi-Model)
                                </option>
                                <option value="claude">
                                    Claude API (Direct)
                                </option>
                                <option value="gemini">
                                    Google Gemini
                                </option>
                                <option value="openai">
                                    OpenAI (Direct)
                                </option>
                                <option value="lm_studio">
                                    LM Studio (Local)
                                </option>
                                <option value="ollama">
                                    Ollama (Local)
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="modelSelect" class="form-label fw-bold"
                                >Model Selection</label
                            >
                            <select class="form-select" id="modelSelect" name="modelSelect" onchange="toggleCustomModelBulk()">
                                <option value="default">Use Default Model</option>
                                <option value="openai/gpt-5">GPT-5</option>
                                <option value="openai/gpt-5-mini">GPT-5 Mini</option>
                                <option value="anthropic/claude-4-sonnet">Claude 4 Sonnet</option>
                                <option value="anthropic/claude-4-opus">Claude 4 Opus</option>
                                <option value="google/gemini-2.5-pro">Gemini 2.5 Pro</option>
                                <option value="openai/gpt-4o">GPT-4o</option>
                                <option value="google/gemini-pro">Gemini Pro</option>
                                <option value="custom">Custom Model...</option>
                            </select>
                            <input
                                type="text"
                                class="form-control mt-2"
                                id="customModel"
                                name="customModel"
                                placeholder="Enter custom model name"
                                style="display: none;" 
                                disabled
                            />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-layer-group me-2"></i>Models to
                            Compare
                        </label>
                        <div class="form-check">
                            <input
                                class="form-check-input"
                                type="checkbox"
                                id="enableComparison"
                                name="enableComparison"
                            />
                            <label
                                class="form-check-label"
                                for="enableComparison"
                            >
                                Enable multi-model comparison
                            </label>
                        </div>
                        <div
                            id="modelSelection"
                            class="mt-3"
                            style="display: none"
                        >
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Popular Models:</h6>
                                    <div id="popularModels">
                                        <!-- Popular models will be loaded dynamically -->
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>Custom Models:</h6>
                                    <div class="mb-3">
                                        <input
                                            type="text"
                                            class="form-control"
                                            id="customModel1"
                                            name="customModels[]"
                                            placeholder="Enter custom model name"
                                        />
                                    </div>
                                    <div class="mb-3">
                                        <input
                                            type="text"
                                            class="form-control"
                                            id="customModel2"
                                            name="customModels[]"
                                            placeholder="Enter custom model name"
                                        />
                                    </div>
                                    <div class="mb-3">
                                        <input
                                            type="text"
                                            class="form-control"
                                            id="customModel3"
                                            name="customModels[]"
                                            placeholder="Enter custom model name"
                                        />
                                    </div>
                                </div>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Select 2 or more models to compare their
                                    grading results. You can also enter custom
                                    model names.
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="prompt" class="form-label fw-bold">
                            <i class="fas fa-comment me-2"></i>Grading
                            Instructions
                        </label>
                        <div class="mb-2 d-flex align-items-center gap-2">
                            <div class="d-flex align-items-center">
                                <label for="selectSavedPrompt" class="me-2 mb-0">Saved Prompt:</label>
                                <select class="form-select form-select-sm" id="selectSavedPrompt" style="max-width: 320px;">
                                    <option value="">No saved prompt</option>
                                    {% for p in saved_prompts %}
                                    <option value="{{ p.id }}">{{ p.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button
                                type="button"
                                class="btn btn-outline-success btn-sm"
                                onclick="saveCurrentPrompt()"
                            >
                                <i class="fas fa-save me-1"></i>Save Current Prompt
                            </button>
                        </div>
                        <textarea
                            class="form-control"
                            id="prompt"
                            rows="4"
                            required
                        >
{{ default_prompt }}</textarea
                        >
                        <input type="hidden" id="saved_prompt_id" value="" />
                        <div
                            id="savedPromptInfo"
                            class="form-text"
                            style="display: none"
                        >
                            <i
                                class="fas fa-check-circle text-success me-1"
                            ></i>
                            <span id="savedPromptName"></span> loaded
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label
                                    for="temperature"
                                    class="form-label fw-bold"
                                >
                                    <i class="fas fa-thermometer-half me-2"></i
                                    >Temperature
                                </label>
                                <input
                                    type="range"
                                    class="form-range"
                                    id="temperature"
                                    name="temperature"
                                    min="0"
                                    max="2"
                                    step="0.1"
                                    value="0.3"
                                    oninput="updateTemperatureValue(this.value)"
                                />
                                <div class="d-flex justify-content-between">
                                    <small class="text-muted"
                                        >0.0 (Focused)</small
                                    >
                                    <small
                                        class="text-muted"
                                        id="temperatureValue"
                                        >0.3</small
                                    >
                                    <small class="text-muted"
                                        >2.0 (Creative)</small
                                    >
                                </div>
                                <div class="form-text">
                                    Controls randomness in AI responses. Lower
                                    values = more focused, higher values = more
                                    creative
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label
                                    for="max_tokens"
                                    class="form-label fw-bold"
                                >
                                    <i class="fas fa-text-width me-2"></i
                                    >Maximum Output Length
                                </label>
                                <input
                                    type="number"
                                    class="form-control"
                                    id="max_tokens"
                                    name="max_tokens"
                                    min="100"
                                    max="8000"
                                    value="2000"
                                    step="100"
                                />
                                <div class="form-text">
                                    Maximum number of tokens in the AI response
                                    (100-8000)
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="marking_scheme" class="form-label fw-bold">
                            <i class="fas fa-clipboard-check me-2"></i>Marking
                            Scheme (Optional)
                        </label>
                        <div class="mb-2 d-flex align-items-center gap-2">
                            <div class="d-flex align-items-center">
                                <label for="selectSavedMarkingScheme" class="me-2 mb-0">Saved Scheme:</label>
                                <select class="form-select form-select-sm" id="selectSavedMarkingScheme" style="max-width: 320px;">
                                    <option value="">No saved marking scheme</option>
                                    {% for s in saved_marking_schemes %}
                                    <option value="{{ s.id }}">{{ s.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button
                                type="button"
                                class="btn btn-outline-success btn-sm"
                                onclick="saveCurrentMarkingScheme()"
                            >
                                <i class="fas fa-save me-1"></i>Save Current Scheme
                            </button>
                        </div>
                        <input
                            type="file"
                            class="form-control"
                            id="marking_scheme"
                            name="marking_scheme"
                            accept=".docx,.pdf,.txt"
                        />
                        <input
                            type="hidden"
                            id="saved_marking_scheme_id"
                            value=""
                        />
                        <div class="form-text">
                            Upload a marking scheme or rubric to guide the
                            grading process. Supported formats: .docx, .pdf,
                            .txt
                        </div>
                        <div
                            id="savedSchemeInfo"
                            class="form-text"
                            style="display: none"
                        >
                            <i
                                class="fas fa-check-circle text-success me-1"
                            ></i>
                            <span id="savedSchemeName"></span> loaded
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-layer-group me-2"></i>Batch Assignment
                        </label>
                        <div class="form-check">
                            <input
                                class="form-check-input"
                                type="radio"
                                id="createNewBatch"
                                name="batchOption"
                                value="new"
                                checked
                            />
                            <label class="form-check-label" for="createNewBatch">
                                Create as standalone job (no batch)
                            </label>
                        </div>
                        <div class="form-check">
                            <input
                                class="form-check-input"
                                type="radio"
                                id="createBatchFromJob"
                                name="batchOption"
                                value="create_batch"
                            />
                            <label class="form-check-label" for="createBatchFromJob">
                                Create new batch using job settings
                            </label>
                        </div>
                        <div class="form-check">
                            <input
                                class="form-check-input"
                                type="radio"
                                id="addToExistingBatch"
                                name="batchOption"
                                value="existing"
                            />
                            <label class="form-check-label" for="addToExistingBatch">
                                Add to existing batch
                            </label>
                        </div>
                        <div id="batchCreationSettings" class="mt-3" style="display: none">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-plus me-2"></i>Batch Settings
                                    </h6>
                                    <div class="mb-3">
                                        <label for="newBatchName" class="form-label fw-bold">Batch Name</label>
                                        <input
                                            type="text"
                                            class="form-control"
                                            id="newBatchName"
                                            placeholder="Enter batch name"
                                        />
                                        <div class="form-text">
                                            Name for the new batch that will be created
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="newBatchDescription" class="form-label fw-bold">Batch Description (Optional)</label>
                                        <textarea
                                            class="form-control"
                                            id="newBatchDescription"
                                            rows="2"
                                            placeholder="Describe this batch..."
                                        ></textarea>
                                    </div>
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        The new batch will inherit all settings from this job (prompt, model, temperature, etc.)
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="batchSelection" class="mt-3" style="display: none">
                            <label for="existingBatch" class="form-label">Select Batch:</label>
                            <select class="form-select" id="existingBatch">
                                <option value="">Loading batches...</option>
                            </select>
                            <div class="form-text">
                                Choose an existing batch to add this job to. All batches except failed, cancelled, or archived ones are available.
                            </div>
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Create Job
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Step 2: File Upload -->
        <div class="card mb-4" id="uploadSection" style="display: none">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-file-upload me-2"></i>Step 2: Upload
                    Documents
                </h5>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <input type="hidden" id="jobId" />

                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Job ID:</strong>
                        <span id="jobIdDisplay">Not set</span>
                    </div>

                    <div class="mb-4">
                        <label for="files" class="form-label fw-bold"
                            >Select Documents</label
                        >
                        <input
                            type="file"
                            class="form-control"
                            id="files"
                            name="files[]"
                            multiple
                            accept=".docx,.pdf"
                            required
                        />
                        <div class="form-text">
                            Select multiple Word (.docx) or PDF files. Maximum
                            50 files per job.
                        </div>
                    </div>

                    <div id="fileList" class="mb-3" style="display: none">
                        <h6>Selected Files:</h6>
                        <div id="fileListContent"></div>
                    </div>

                    <div class="d-grid">
                        <button
                            type="submit"
                            class="btn btn-success"
                            id="uploadBtn"
                        >
                            <i class="fas fa-upload me-2"></i>Upload and Start
                            Processing
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Job Status -->
        <div class="card" id="jobStatus" style="display: none">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>Job Status
                </h5>
            </div>
            <div class="card-body">
                <div id="statusContent"></div>
                <div class="mt-3">
                    <a href="/jobs" class="btn btn-outline-primary">
                        <i class="fas fa-list me-2"></i>View All Jobs
                    </a>
                    <a
                        href="/bulk_upload"
                        class="btn btn-outline-secondary"
                        onclick="resetForm()"
                    >
                        <i class="fas fa-plus me-2"></i>Create Another Job
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block scripts %}
<script>
    let currentJobId = null;

    function loadAvailableModels() {
        const provider = document.getElementById('provider').value;
        const popularModelsDiv = document.getElementById('popularModels');

        // Fetch available models for the selected provider
        fetch(`/api/models/${provider}`)
            .then(response => response.json())
            .then(data => {
                popularModelsDiv.innerHTML = '';

                if (data.popular && data.popular.length > 0) {
                    data.popular.forEach(model => {
                        const modelId = model.replace(/[^a-zA-Z0-9]/g, '_');
                        const displayName = getModelDisplayName(model);

                        const div = document.createElement('div');
                        div.className = 'form-check';
                        div.innerHTML = `
                            <input class="form-check-input model-checkbox" type="checkbox"
                                   name="models_to_compare[]" value="${model}" id="${modelId}">
                            <label class="form-check-label" for="${modelId}">
                                ${displayName}
                            </label>
                        `;
                        popularModelsDiv.appendChild(div);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading models:', error);
                popularModelsDiv.innerHTML = '<p class="text-muted">Error loading models</p>';
            });
    }

    function getModelDisplayName(modelName) {
        // Create a more readable display name from the model identifier
        const nameMap = {
            'anthropic/claude-opus-4-1': 'Claude Opus 4.1 (Latest)',
            'openai/gpt-5': 'GPT-5',
            'openai/gpt-4o': 'GPT-4o',
            'openai/gpt-4o-mini': 'GPT-4o Mini',
            'anthropic/claude-3-opus-20240229': 'Claude 3 Opus',
            'meta-llama/llama-3.1-70b-instruct': 'Llama 3.1 70B',
            'google/gemini-2.5-pro': 'Gemini 2.5 Pro (Latest)',
            'google/gemini-pro-1.5': 'Gemini Pro 1.5',
            'mistralai/mistral-7b-instruct': 'Mistral 7B',
            'openai/gpt-4-turbo': 'GPT-4 Turbo',
            'anthropic/claude-3-haiku-20240307': 'Claude 3 Haiku',
            'claude-4-opus-20250805': 'Claude 4 Opus (Latest)',
            'claude-3-5-sonnet-20241022': 'Claude 3.5 Sonnet',
            'claude-3-opus-20240229': 'Claude 3 Opus',
            'claude-3-sonnet-20240229': 'Claude 3 Sonnet',
            'claude-3-haiku-20240307': 'Claude 3 Haiku',
            'local-model': 'Local Model',
            'llama-3.1-70b-instruct': 'Llama 3.1 70B',
            'mistral-7b-instruct': 'Mistral 7B',
            'codellama-34b-instruct': 'Code Llama 34B'
        };

        return nameMap[modelName] || modelName;
    }

    function updateTemperatureValue(value) {
        document.getElementById('temperatureValue').textContent = value;
    }

    function loadJobTemplate() {
        const templateId = document.getElementById('jobTemplateSelect').value;
        if (!templateId) {
            alert('Please select a template first.');
            return;
        }

        const loadBtn = document.getElementById('loadTemplateBtn');
        const originalText = loadBtn.innerHTML;
        
        loadBtn.disabled = true;
        loadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Loading...';

        fetch(`/api/job-templates/${templateId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const template = data.template;
                    
                    // Populate form fields with template data
                    document.getElementById('jobName').value = template.name || '';
                    document.getElementById('jobDescription').value = template.description || '';
                    document.getElementById('provider').value = template.provider || 'openrouter';
                    document.getElementById('prompt').value = template.prompt || '';
                    document.getElementById('temperature').value = template.temperature || 0.3;
                    document.getElementById('max_tokens').value = template.max_tokens || 2000;
                    document.getElementById('temperatureValue').textContent = template.temperature || 0.3;
                    
                    // Handle model selection
                    if (template.model) {
                        document.getElementById('modelSelect').value = template.model;
                        toggleCustomModelBulk();
                    }
                    
                    // Handle marking scheme if present
                    if (template.saved_marking_scheme_id) {
                        document.getElementById('saved_marking_scheme_id').value = template.saved_marking_scheme_id;
                        document.getElementById('savedSchemeName').textContent = template.marking_scheme_name || '';
                        document.getElementById('savedSchemeInfo').style.display = 'block';
                    }
                    
                    // Show template info
                    const templateInfo = document.getElementById('templateInfo');
                    const templateInfoText = document.getElementById('templateInfoText');
                    templateInfoText.textContent = `Template "${template.name}" loaded successfully.`;
                    templateInfo.style.display = 'block';
                    
                    // Scroll to template info
                    templateInfo.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    
                    // Load available models for the selected provider
                    loadAvailableModels();
                    
                } else {
                    alert('Error loading template: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error loading template: ' + error.message);
            })
            .finally(() => {
                loadBtn.disabled = false;
                loadBtn.innerHTML = originalText;
            });
    }

    // Add event listener for template selection change
    document.addEventListener('DOMContentLoaded', function() {
        const templateSelect = document.getElementById('jobTemplateSelect');
        if (templateSelect) {
            templateSelect.addEventListener('change', function() {
                // Hide template info when selection changes
                document.getElementById('templateInfo').style.display = 'none';
            });
        }
    });

    function toggleCustomModelBulk() {
        const modelSelect = document.getElementById('modelSelect');
        const customModelInput = document.getElementById('customModel');
        
        if (modelSelect.value === 'custom') {
            customModelInput.style.display = 'block';
            customModelInput.disabled = false;
        } else {
            customModelInput.style.display = 'none';
            customModelInput.disabled = true;
            customModelInput.value = '';
        }
    }

    function resetForm() {
        document.getElementById('jobForm').reset();
        document.getElementById('uploadForm').reset();
        document.getElementById('uploadSection').style.display = 'none';
        document.getElementById('jobStatus').style.display = 'none';
        document.getElementById('fileList').style.display = 'none';
        document.getElementById('jobIdDisplay').textContent = 'Not set';
        currentJobId = null;

        // Reset model selection
        document.getElementById('enableComparison').checked = false;
        document.getElementById('modelSelect').value = 'default';
        toggleCustomModelBulk();
        document.getElementById('modelSelection').style.display = 'none';
        // Clear custom model inputs
        document.querySelectorAll('input[name="customModels[]"]').forEach(input => {
            input.value = '';
        });

        // Reset temperature display
        document.getElementById('temperatureValue').textContent = '0.3';

        // Reset batch selection
        document.getElementById('createNewBatch').checked = true;
        document.getElementById('createBatchFromJob').checked = false;
        document.getElementById('addToExistingBatch').checked = false;
        document.getElementById('batchSelection').style.display = 'none';
        document.getElementById('batchCreationSettings').style.display = 'none';
        document.getElementById('newBatchName').value = '';
        document.getElementById('newBatchDescription').value = '';

        // Remove any success messages
        const successMsgs = document.querySelectorAll('.alert-success');
        successMsgs.forEach(msg => msg.remove());

        // Load available models again
        loadAvailableModels();
    }

    function toggleModelSelection() {
        const enableComparison = document.getElementById('enableComparison');
        const modelSelection = document.getElementById('modelSelection');

        if (enableComparison.checked) {
            modelSelection.style.display = 'block';
        } else {
            modelSelection.style.display = 'none';
            // Clear custom model inputs
            document.querySelectorAll('input[name="customModels[]"]').forEach(input => {
                input.value = '';
            });
        }
    }

    function updateFileList() {
        const fileInput = document.getElementById('files');
        const fileList = document.getElementById('fileList');
        const fileListContent = document.getElementById('fileListContent');

        if (fileInput.files.length > 0) {
            fileListContent.innerHTML = '';
            Array.from(fileInput.files).forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'd-flex justify-content-between align-items-center p-2 border rounded mb-2';
                fileItem.innerHTML = `
                    <div>
                        <i class="fas fa-file me-2"></i>
                        ${file.name}
                    </div>
                    <small class="text-muted">${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                `;
                fileListContent.appendChild(fileItem);
            });
            fileList.style.display = 'block';
        } else {
            fileList.style.display = 'none';
        }
    }

    document.getElementById('files').addEventListener('change', updateFileList);

    // Add event listener for comparison toggle
    document.getElementById('enableComparison').addEventListener('change', toggleModelSelection);

    // Add event listener for provider change
    document.getElementById('provider').addEventListener('change', function() {
        loadAvailableModels();
    });

    function toggleBatchSelection() {
        const addToExisting = document.getElementById('addToExistingBatch');
        const createBatch = document.getElementById('createBatchFromJob');
        const batchSelection = document.getElementById('batchSelection');
        const batchCreationSettings = document.getElementById('batchCreationSettings');
        
        if (addToExisting.checked) {
            batchSelection.style.display = 'block';
            batchCreationSettings.style.display = 'none';
            loadAvailableBatches();
        } else if (createBatch.checked) {
            batchSelection.style.display = 'none';
            batchCreationSettings.style.display = 'block';
        } else {
            batchSelection.style.display = 'none';
            batchCreationSettings.style.display = 'none';
        }
    }

    function loadAvailableBatches() {
        const batchSelect = document.getElementById('existingBatch');
        batchSelect.innerHTML = '<option value="">Loading batches...</option>';
        
        fetch('/api/batches?per_page=100')
            .then(response => response.json())
            .then(data => {
                batchSelect.innerHTML = '<option value="">Select a batch...</option>';
                
                if (data.success && data.batches && data.batches.length > 0) {
                    // Filter to show batches that can accept new jobs (exclude failed, cancelled, archived)
                    const availableBatches = data.batches.filter(batch => 
                        !['failed', 'cancelled', 'archived'].includes(batch.status)
                    );
                    
                    if (availableBatches.length > 0) {
                        availableBatches.forEach(batch => {
                            const option = document.createElement('option');
                            option.value = batch.id;
                            option.textContent = `${batch.batch_name} (${batch.total_jobs} jobs, ${batch.status})`;
                            batchSelect.appendChild(option);
                        });
                    } else {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'No available batches';
                        batchSelect.appendChild(option);
                    }
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No batches available';
                    batchSelect.appendChild(option);
                }
            })
            .catch(error => {
                console.error('Error loading batches:', error);
                batchSelect.innerHTML = '<option value="">Error loading batches</option>';
            });
    }

    // Add event listeners for batch selection
    document.getElementById('createNewBatch').addEventListener('change', toggleBatchSelection);
    document.getElementById('createBatchFromJob').addEventListener('change', toggleBatchSelection);
    document.getElementById('addToExistingBatch').addEventListener('change', toggleBatchSelection);

    // Load available models when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadAvailableModels();
    });

    document.getElementById('jobForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating Job...';

        // Get selected models for comparison
        const selectedModels = [];
        if (document.getElementById('enableComparison').checked) {
            document.querySelectorAll('.model-checkbox:checked').forEach(checkbox => {
                selectedModels.push(checkbox.value);
            });

            // Add custom models
            document.querySelectorAll('input[name="customModels[]"]').forEach(input => {
                if (input.value.trim()) {
                    selectedModels.push(input.value.trim());
                }
            });
        }

        // Handle marking scheme - check for saved scheme first, then file upload
        const savedMarkingSchemeId = document.getElementById('saved_marking_scheme_id').value;
        const markingSchemeFile = document.getElementById('marking_scheme').files[0];
        let markingSchemeId = null;

        if (savedMarkingSchemeId) {
            // Use saved marking scheme
            markingSchemeId = null; // We'll use saved_marking_scheme_id instead
        } else if (markingSchemeFile) {
            // Upload marking scheme file
            const markingSchemeFormData = new FormData();
            markingSchemeFormData.append('marking_scheme', markingSchemeFile);
            markingSchemeFormData.append('name', markingSchemeFile.name);
            markingSchemeFormData.append('description', 'Marking scheme for ' + document.getElementById('jobName').value);

            try {
                const markingSchemeResponse = await fetch('/upload_marking_scheme', {
                    method: 'POST',
                    body: markingSchemeFormData
                });

                const markingSchemeResult = await markingSchemeResponse.json();
                if (markingSchemeResult.success) {
                    markingSchemeId = markingSchemeResult.marking_scheme_id;
                } else {
                    alert('Error uploading marking scheme: ' + markingSchemeResult.error);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    return;
                }
            } catch (error) {
                alert('Error uploading marking scheme: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                return;
            }
        }

        // Handle batch assignment
        const addToExistingBatch = document.getElementById('addToExistingBatch').checked;
        const createBatchFromJob = document.getElementById('createBatchFromJob').checked;
        const selectedBatchId = addToExistingBatch ? document.getElementById('existingBatch').value : null;
        let createdBatchId = null;

        // Create batch first if option is selected
        if (createBatchFromJob) {
            const batchName = document.getElementById('newBatchName').value.trim();
            if (!batchName) {
                alert('Please enter a batch name.');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                return;
            }

            const batchData = {
                batch_name: batchName,
                description: document.getElementById('newBatchDescription').value.trim(),
                provider: document.getElementById('provider').value,
                model: document.getElementById('customModel').value || null,
                models_to_compare: selectedModels.length > 0 ? selectedModels : null,
                prompt: document.getElementById('prompt').value,
                priority: parseInt(document.getElementById('priority').value),
                temperature: parseFloat(document.getElementById('temperature').value),
                max_tokens: parseInt(document.getElementById('max_tokens').value),
                saved_prompt_id: document.getElementById('saved_prompt_id').value || null,
                saved_marking_scheme_id: document.getElementById('saved_marking_scheme_id').value || null
            };

            try {
                const batchResponse = await fetch('/create_batch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(batchData)
                });

                const batchResult = await batchResponse.json();
                if (batchResult.success) {
                    createdBatchId = batchResult.batch_id;
                } else {
                    alert('Error creating batch: ' + batchResult.error);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    return;
                }
            } catch (error) {
                alert('Error creating batch: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                return;
            }
        }

        const formData = {
            job_name: document.getElementById('jobName').value,
            description: document.getElementById('jobDescription').value,
            provider: document.getElementById('provider').value,
            model: document.getElementById('customModel').value || null,
            models_to_compare: selectedModels.length > 0 ? selectedModels : null,
            prompt: document.getElementById('prompt').value,
            priority: parseInt(document.getElementById('priority').value),
            temperature: parseFloat(document.getElementById('temperature').value),
            max_tokens: parseInt(document.getElementById('max_tokens').value),
            marking_scheme_id: markingSchemeId,
            saved_prompt_id: document.getElementById('saved_prompt_id').value || null,
            saved_marking_scheme_id: document.getElementById('saved_marking_scheme_id').value || null,
            batch_id: selectedBatchId || createdBatchId,
            job_template_id: document.getElementById('jobTemplateSelect').value || null
        };

        fetch('/create_job', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentJobId = data.job_id;
                document.getElementById('jobId').value = data.job_id;
                document.getElementById('jobIdDisplay').textContent = data.job_id;
                document.getElementById('uploadSection').style.display = 'block';

                // Show success message
                const jobForm = document.getElementById('jobForm');
                const successMsg = document.createElement('div');
                successMsg.className = 'alert alert-success mt-3';
                let successText = `Job "${formData.job_name}" created successfully! You can now upload files.`;
                if (createdBatchId) {
                    successText = `Batch "${document.getElementById('newBatchName').value}" and job "${formData.job_name}" created successfully! You can now upload files.`;
                }
                successMsg.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    ${successText}
                `;
                jobForm.appendChild(successMsg);

                document.getElementById('uploadSection').scrollIntoView({ behavior: 'smooth' });
            } else {
                alert('Error creating job: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error creating job: ' + error.message);
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
    });

    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        e.preventDefault();

        // Check if we have a job ID
        const jobId = document.getElementById('jobId').value;
        if (!jobId) {
            alert('Please create a job first before uploading files.');
            return;
        }

        const formData = new FormData(this);

        // Ensure job_id is included in the form data
        formData.set('job_id', jobId);
        
        // Include template ID for usage tracking
        const templateId = document.getElementById('jobTemplateSelect').value;
        if (templateId) {
            formData.set('job_template_id', templateId);
        }

        const uploadBtn = document.getElementById('uploadBtn');
        const originalText = uploadBtn.innerHTML;

        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading...';

        fetch('/upload_bulk', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('jobStatus').style.display = 'block';

                const statusContent = document.getElementById('statusContent');
                statusContent.innerHTML = `
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle me-2"></i>Job Created Successfully!</h6>
                        <p class="mb-2"><strong>Job ID:</strong> ${data.job_id}</p>
                        <p class="mb-2"><strong>Files Uploaded:</strong> ${data.message}</p>
                        <p class="mb-0">Your documents are now being processed in the background. You can monitor progress on the jobs page.</p>
                    </div>
                `;

                document.getElementById('jobStatus').scrollIntoView({ behavior: 'smooth' });
            } else {
                alert('Error uploading files: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error uploading files: ' + error.message);
        })
        .finally(() => {
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = originalText;
        });
    });

    // Saved Configurations Functions
    // Replace dialog selection with dropdown change handler for saved prompts
    document.addEventListener('DOMContentLoaded', function() {
        const savedPrompts = {{ saved_prompts|tojson }};
        const promptSelect = document.getElementById('selectSavedPrompt');
        if (promptSelect) {
            promptSelect.addEventListener('change', function() {
                const selectedId = this.value;
                if (!selectedId) {
                    document.getElementById('saved_prompt_id').value = '';
                    document.getElementById('savedPromptInfo').style.display = 'none';
                    return;
                }
                const selected = savedPrompts.find(p => String(p.id) === String(selectedId));
                if (selected) {
                    document.getElementById('prompt').value = selected.prompt_text || '';
                    document.getElementById('saved_prompt_id').value = selected.id;
                    document.getElementById('savedPromptName').textContent = selected.name || '';
                    document.getElementById('savedPromptInfo').style.display = 'block';
                }
            });
        }
    });

    function saveCurrentPrompt() {
        const promptText = document.getElementById('prompt').value;

        if (!promptText.trim()) {
            alert('Please enter a prompt to save.');
            return;
        }

        // Clear previous modal data
        document.getElementById('promptName').value = '';
        document.getElementById('promptDescription').value = '';
        document.getElementById('promptCategory').value = '';

        // Show the modal
        new bootstrap.Modal(document.getElementById('savePromptModal')).show();
    }

    function submitPromptSave() {
        const name = document.getElementById('promptName').value.trim();
        const description = document.getElementById('promptDescription').value.trim();
        const category = document.getElementById('promptCategory').value.trim();
        const promptText = document.getElementById('prompt').value;
        const saveBtn = document.getElementById('savePromptBtn');

        if (!name) {
            document.getElementById('promptName').classList.add('is-invalid');
            document.getElementById('promptName').focus();
            return;
        }

        // Clear validation state
        document.getElementById('promptName').classList.remove('is-invalid');

        // Show loading state
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';

        // Do not save model or provider as part of the saved prompt; model/provider selection is configured per job separately.
        const formData = {
            name: name,
            description: description || '',
            category: category || '',
            prompt_text: promptText
        };

        fetch('/api/saved-prompts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal and show success
                bootstrap.Modal.getInstance(document.getElementById('savePromptModal')).hide();
                
                // Show success notification
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
                alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>Prompt saved successfully!
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.body.appendChild(alertDiv);
                
                // Auto-remove notification after 3 seconds
                setTimeout(() => {
                    alertDiv.remove();
                }, 3000);
                
                // Optionally refresh the saved prompts dropdown
                location.reload();
            } else {
                alert('Error saving prompt: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error saving prompt: ' + error.message);
        })
        .finally(() => {
            // Reset button state
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>Save Prompt';
        });
    }

    // Replace dialog selection with dropdown change handler for saved marking schemes
    document.addEventListener('DOMContentLoaded', function() {
        const savedSchemes = {{ saved_marking_schemes|tojson }};
        const schemeSelect = document.getElementById('selectSavedMarkingScheme');
        if (schemeSelect) {
            schemeSelect.addEventListener('change', function() {
                const selectedId = this.value;
                if (!selectedId) {
                    document.getElementById('saved_marking_scheme_id').value = '';
                    document.getElementById('savedSchemeInfo').style.display = 'none';
                    return;
                }
                const selected = savedSchemes.find(s => String(s.id) === String(selectedId));
                if (selected) {
                    document.getElementById('saved_marking_scheme_id').value = selected.id;
                    document.getElementById('savedSchemeName').textContent = selected.name || '';
                    document.getElementById('savedSchemeInfo').style.display = 'block';
                    // Clear the file input since we're using a saved scheme
                    document.getElementById('marking_scheme').value = '';
                }
            });
        }
    });

    function saveCurrentMarkingScheme() {
        const fileInput = document.getElementById('marking_scheme');
        if (!fileInput.files[0]) {
            alert('Please select a marking scheme file to save.');
            return;
        }

        // Clear previous modal data
        document.getElementById('markingSchemeName').value = '';
        document.getElementById('markingSchemeDescription').value = '';
        document.getElementById('markingSchemeCategory').value = '';

        // Show the modal
        new bootstrap.Modal(document.getElementById('saveMarkingSchemeModal')).show();
    }

    function submitMarkingSchemeSave() {
        const name = document.getElementById('markingSchemeName').value.trim();
        const description = document.getElementById('markingSchemeDescription').value.trim();
        const category = document.getElementById('markingSchemeCategory').value.trim();
        const fileInput = document.getElementById('marking_scheme');
        const saveBtn = document.getElementById('saveMarkingSchemeBtn');

        if (!name) {
            document.getElementById('markingSchemeName').classList.add('is-invalid');
            document.getElementById('markingSchemeName').focus();
            return;
        }

        if (!fileInput.files[0]) {
            alert('Please select a marking scheme file to save.');
            return;
        }

        // Clear validation state
        document.getElementById('markingSchemeName').classList.remove('is-invalid');

        // Show loading state
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';

        const formData = new FormData();
        formData.append('name', name);
        formData.append('description', description || '');
        formData.append('category', category || '');
        formData.append('marking_scheme', fileInput.files[0]);

        fetch('/api/saved-marking-schemes', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal and show success
                bootstrap.Modal.getInstance(document.getElementById('saveMarkingSchemeModal')).hide();
                
                // Show success notification
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
                alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>Marking scheme saved successfully!
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.body.appendChild(alertDiv);
                
                // Auto-remove notification after 3 seconds
                setTimeout(() => {
                    alertDiv.remove();
                }, 3000);
                
                // Optionally refresh the saved marking schemes dropdown
                location.reload();
            } else {
                alert('Error saving marking scheme: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error saving marking scheme: ' + error.message);
        })
        .finally(() => {
            // Reset button state
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>Save Marking Scheme';
        });
    }
</script>

<!-- Save Prompt Modal -->
<div class="modal fade" id="savePromptModal" tabindex="-1" aria-labelledby="savePromptModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="savePromptModalLabel">
                    <i class="fas fa-save me-2"></i>Save Current Prompt
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="savePromptForm">
                    <div class="mb-3">
                        <label for="promptName" class="form-label">
                            <i class="fas fa-tag me-1"></i>Name *
                        </label>
                        <input type="text" class="form-control" id="promptName" required 
                               placeholder="Enter a descriptive name for this prompt">
                    </div>
                    <div class="mb-3">
                        <label for="promptDescription" class="form-label">
                            <i class="fas fa-info-circle me-1"></i>Description
                        </label>
                        <textarea class="form-control" id="promptDescription" rows="3"
                                  placeholder="Optional: Describe what this prompt is used for"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="promptCategory" class="form-label">
                            <i class="fas fa-folder me-1"></i>Category
                        </label>
                        <input type="text" class="form-control" id="promptCategory" 
                               placeholder="Optional: essay, report, assignment, etc.">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitPromptSave()" id="savePromptBtn">
                    <i class="fas fa-save me-1"></i>Save Prompt
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Save Marking Scheme Modal -->
<div class="modal fade" id="saveMarkingSchemeModal" tabindex="-1" aria-labelledby="saveMarkingSchemeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="saveMarkingSchemeModalLabel">
                    <i class="fas fa-save me-2"></i>Save Current Marking Scheme
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="saveMarkingSchemeForm">
                    <div class="mb-3">
                        <label for="markingSchemeName" class="form-label">
                            <i class="fas fa-tag me-1"></i>Name *
                        </label>
                        <input type="text" class="form-control" id="markingSchemeName" required 
                               placeholder="Enter a descriptive name for this marking scheme">
                    </div>
                    <div class="mb-3">
                        <label for="markingSchemeDescription" class="form-label">
                            <i class="fas fa-info-circle me-1"></i>Description
                        </label>
                        <textarea class="form-control" id="markingSchemeDescription" rows="3"
                                  placeholder="Optional: Describe what this marking scheme covers"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="markingSchemeCategory" class="form-label">
                            <i class="fas fa-folder me-1"></i>Category
                        </label>
                        <input type="text" class="form-control" id="markingSchemeCategory" 
                               placeholder="Optional: essay, report, assignment, etc.">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitMarkingSchemeSave()" id="saveMarkingSchemeBtn">
                    <i class="fas fa-save me-1"></i>Save Marking Scheme
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
