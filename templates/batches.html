{% extends "base.html" %}

{% block title %}Batches{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Batch Management</h1>
    <p>This page will display the list of batches and allow for their management.</p>
    
    <div id="loading" style="display: none;">Loading batches...</div>
    <div id="error" class="alert alert-danger" style="display: none;"></div>

    <!-- Filtering and Search Controls -->
    <div class="card mb-3">
        <div class="card-header">Filter Batches</div>
        <div class="card-body">
            <form id="filterForm" class="row g-3">
                <div class="col-md-3">
                    <label for="statusFilter" class="form-label">Status</label>
                    <select class="form-select" id="statusFilter" name="status">
                        <option value="all">All</option>
                        {% for status in filter_options.statuses %}
                        <option value="{{ status }}" {% if current_filters.status == status %}selected{% endif %}>{{ status | title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="priorityFilter" class="form-label">Priority</label>
                    <select class="form-select" id="priorityFilter" name="priority">
                        <option value="all">All</option>
                        {% for priority in filter_options.priorities %}
                        <option value="{{ priority }}" {% if current_filters.priority and current_filters.priority == priority|string %}selected{% endif %}>{{ priority }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="tagFilter" class="form-label">Tag</label>
                    <select class="form-select" id="tagFilter" name="tag">
                        <option value="">All</option>
                        {% for tag in filter_options.tags %}
                        <option value="{{ tag }}" {% if current_filters.tag == tag %}selected{% endif %}>{{ tag }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="searchFilter" class="form-label">Search</label>
                    <input type="text" class="form-control" id="searchFilter" name="search" value="{{ current_filters.search }}" placeholder="Search by name or description">
                </div>
                <div class="col-12 mt-3">
                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                    <button type="button" class="btn btn-secondary" id="clearFilters">Clear Filters</button>
                </div>
            </form>
        </div>
    </div>

    <h2 class="mt-4">Batches</h2>
    <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#createBatchModal">Create New Batch</button>
    
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Status</th>
                    <th>Progress</th>
                    <th>Jobs (C/F/T)</th>
                    <th>Last Updated</th>
                    <th>Actions</th>
                </tr>
                </thead>
            <tbody id="batches-table-body">
                {% if batches %}
                    {% for batch in batches %}
                    <tr>
                        <td><a href="{{ url_for('batch_detail', batch_id=batch.id) }}">{{ batch.batch_name }}</a></td>
                        <td>
                            <span class="badge bg-{{ {
                                'draft': 'secondary',
                                'pending': 'info',
                                'processing': 'primary',
                                'paused': 'warning',
                                'completed': 'success',
                                'completed_with_errors': 'warning',
                                'failed': 'danger',
                                'cancelled': 'dark',
                                'archived': 'light'
                            }[batch.status] }}">{{ batch.status | title }}</span>
                        </td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar {% if batch.status == 'failed' %}bg-danger{% elif batch.status == 'completed' %}bg-success{% elif batch.progress > 0 %}bg-info{% else %}bg-secondary{% endif %}" role="progressbar" style="width: {{ batch.progress }}%;" aria-valuenow="{{ batch.progress }}" aria-valuemin="0" aria-valuemax="100">{{ batch.progress }}%</div>
                            </div>
                        </td>
                        <td>
                            {{ batch.completed_jobs }}/{{ batch.failed_jobs }}/{{ batch.total_jobs }}
                            {% if batch.status in ['draft', 'pending', 'paused'] %}
                            <br><small class="text-success"><i class="fas fa-plus-circle me-1"></i>Can add jobs</small>
                            {% endif %}
                        </td>
                        <td>{{ batch.updated_at[:16].replace('T', ' ') if batch.updated_at else 'N/A' }}</td>
                        <td>
                            <div class="d-flex">
                                <!-- Action Buttons -->
                                {% if batch.can_start %}
                                <button class="btn btn-sm btn-primary me-1 start-batch-btn" data-id="{{ batch.id }}">Start</button>
                                {% endif %}
                                {% if batch.can_pause %}
                                <button class="btn btn-sm btn-warning me-1 pause-batch-btn" data-id="{{ batch.id }}">Pause</button>
                                {% endif %}
                                {% if batch.can_resume %}
                                <button class="btn btn-sm btn-info me-1 resume-batch-btn" data-id="{{ batch.id }}">Resume</button>
                                {% endif %}
                                {% if batch.can_retry %}
                                <button class="btn btn-sm btn-secondary me-1 retry-batch-btn" data-id="{{ batch.id }}">Retry Failed</button>
                                {% endif %}
                                <button class="btn btn-sm btn-danger me-1 delete-batch-btn" data-id="{{ batch.id }}">Delete</button>
                                <button class="btn btn-sm btn-secondary me-1 duplicate-batch-btn" data-id="{{ batch.id }}">Duplicate</button>
                                <a href="{{ url_for('api_export_batch', batch_id=batch.id) }}" class="btn btn-sm btn-light me-1">Export</a>
                                <button class="btn btn-sm btn-dark archive-batch-btn" data-id="{{ batch.id }}">Archive</button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                <tr><td colspan="6" class="text-center">No batches found.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Create Batch Modal -->
<div class="modal fade" id="createBatchModal" tabindex="-1" aria-labelledby="createBatchModalLabel" aria-hidden="true" data-bs-backdrop="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createBatchModalLabel">Create New Batch</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createBatchForm">
                    <div class="mb-3">
                        <label for="batchName" class="form-label">Batch Name</label>
                        <input type="text" class="form-control" id="batchName" name="batch_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="batchDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="batchDescription" name="description" rows="3"></textarea>
                    </div>
                                        <div class="mb-3">
                        <label for="batchTemplate" class="form-label">Select Template (Optional)</label>
                        <select class="form-select" id="batchTemplate" name="template_id">
                            <option value="">No Template</option>
                            {% for template in templates %}
                            <option value="{{ template.id }}" 
                                    data-settings="{{ template.default_settings | tojson }}"
                                    data-job-structure="{{ template.job_structure | tojson }}"
                                    data-processing-rules="{{ template.processing_rules | tojson }}">
                                {{ template.name }} ({{ template.type|title }})
                            </option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">
                            <a href="/templates" target="_blank">Manage templates</a> or create new ones
                        </small>
                    </div></search>
</search_and_replace>
                     <div class="row">
                         <div class="col-md-6 mb-3">
                             <label for="batchProvider" class="form-label">Default Provider</label>
                             <div class="d-flex align-items-center">
                                 <select class="form-select" id="batchProvider" name="provider">
                                     <option value="openrouter">OpenRouter</option>
                                     <option value="claude">Claude</option>
                                     <option value="lm_studio">LM Studio</option>
                                 </select>
                                 <button type="button" class="btn btn-sm btn-outline-secondary ms-2" 
                                         onclick="refreshBatchProviderModels()" 
                                         id="refreshBatchModelsBtn" 
                                         title="Refresh available models">
                                     <i class="fas fa-sync-alt"></i>
                                 </button>
                             </div>
                             <div class="mt-1">
                                 <small class="text-muted" id="batchModelLoadingStatus">Ready</small>
                             </div>
                         </div>
                         <div class="col-md-6 mb-3">
                             <label for="batchModel" class="form-label">Default Model</label>
                             <div class="d-flex align-items-center">
                                 <select class="form-select" id="batchModel" name="model">
                                     <option value="">Select a model...</option>
                                 </select>
                                 <div class="spinner-border spinner-border-sm text-primary ms-2" 
                                      id="batchModelSpinner" style="display: none;" role="status">
                                     <span class="visually-hidden">Loading...</span>
                                 </div>
                             </div>
                             <div class="invalid-feedback" id="batchModelError" style="display: none;"></div>
                         </div>
                     </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="batchTemperature" class="form-label">Temperature</label>
                            <input type="number" step="0.1" min="0" max="1" class="form-control" id="batchTemperature" name="temperature" value="0.3">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="batchMaxTokens" class="form-label">Max Tokens</label>
                            <input type="number" class="form-control" id="batchMaxTokens" name="max_tokens" value="2000">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="batchPriority" class="form-label">Priority (1-10)</label>
                        <input type="number" class="form-control" id="batchPriority" name="priority" min="1" max="10" value="5">
                    </div>
                    <div class="mb-3">
                        <label for="batchPrompt" class="form-label">Default Prompt (Optional)</label>
                        <textarea class="form-control" id="batchPrompt" name="prompt" rows="3" placeholder="Default prompt for all jobs in this batch"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="batchSavedPrompt" class="form-label">Saved Prompt (Optional)</label>
                            <select class="form-select" id="batchSavedPrompt" name="saved_prompt_id">
                                <option value="">No saved prompt</option>
                                {% for prompt in saved_prompts %}
                                <option value="{{ prompt.id }}">{{ prompt.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="batchSavedMarkingScheme" class="form-label">Saved Marking Scheme (Optional)</label>
                            <select class="form-select" id="batchSavedMarkingScheme" name="saved_marking_scheme_id">
                                <option value="">No saved marking scheme</option>
                                {% for scheme in saved_marking_schemes %}
                                <option value="{{ scheme.id }}">{{ scheme.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enableMultiModelComparison" name="enable_multi_model_comparison">
                            <label class="form-check-label" for="enableMultiModelComparison">
                                Enable multi-model comparison for batch
                            </label>
                        </div>
                        <small class="form-text text-muted">When enabled, jobs in this batch will run against multiple AI models for comparison</small>
                    </div>
                    
                    <!-- Multi-model selection section -->
                    <div id="multiModelSection" style="display: none;" class="mb-3">
                        <label class="form-label">Select Models to Compare</label>
                        <!-- Unified Model Selection Interface -->
                        <div class="unified-model-selection">
                            <div class="selection-header mb-3">
                                <div class="row align-items-center">
                                    <div class="col-md-4">
                                        <div class="provider-filters">
                                            <label class="form-label mb-1">Filter by Providers:</label>
                                            <div id="batchProviderFilters" class="d-flex flex-wrap gap-2">
                                                <!-- Provider filter checkboxes will be loaded dynamically -->
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="search-bar">
                                            <label class="form-label mb-1">Search Models:</label>
                                            <input type="text" class="form-control" id="batchModelSearch"
                                                   placeholder="Search across all models...">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="selection-info">
                                            <label class="form-label mb-1">Selected Models:</label>
                                            <div class="d-flex align-items-center gap-2">
                                                <span id="batchSelectedCount" class="badge bg-primary">0</span>
                                                <span>models selected</span>
                                                <button type="button" class="btn btn-sm btn-outline-secondary ms-auto"
                                                        onclick="clearAllBatchModelSelections()">Clear All</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="models-container">
                                <div id="batchAllModelsContainer">
                                    <!-- Models from all providers will be loaded here -->
                                </div>
                            </div>
                            <div class="custom-models-section mt-3">
                                <h6>Custom Models:</h6>
                                <div class="row">
                                    <div class="col-md-4 mb-2">
                                        <input type="text" class="form-control" id="batchCustomModel1" name="customModels[]"
                                               placeholder="Enter custom model name">
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <input type="text" class="form-control" id="batchCustomModel2" name="customModels[]"
                                               placeholder="Enter custom model name">
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <input type="text" class="form-control" id="batchCustomModel3" name="customModels[]"
                                               placeholder="Enter custom model name">
                                    </div>
                                </div>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Select 2 or more models from different providers to compare their grading results.
                                    Use provider filters to focus on specific providers, or search to find specific models.
                                </small>
                            </div>
                        </div>
                        <small class="form-text text-muted">Select 2 or more models to enable comparison. Individual jobs can override these settings.</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="batchTags" class="form-label">Tags (comma-separated)</label>
                        <input type="text" class="form-control" id="batchTags" name="tags" placeholder="e.g., academic, research">
                    </div>
                    <div class="mb-3">
                        <label for="batchDeadline" class="form-label">Deadline (Optional)</label>
                        <input type="datetime-local" class="form-control" id="batchDeadline" name="deadline">
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="autoAssignJobs" name="auto_assign_jobs">
                        <label class="form-check-label" for="autoAssignJobs">
                            Auto-assign jobs (automatically add new uploads to this batch)
                        </label>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Create Batch</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Handle filter form submission
        $('#filterForm').on('submit', function(e) {
            e.preventDefault();
            const formData = new URLSearchParams($(this).serialize()).toString();
            window.location.search = formData; // Reload page with filters
        });
        
        // Handle multi-model comparison toggle
        $('#enableMultiModelComparison').on('change', function() {
            const multiModelSection = document.getElementById('multiModelSection');
            if ($(this).is(':checked')) {
                multiModelSection.style.display = 'block';
                loadBatchAllProvidersModels();
            } else {
                multiModelSection.style.display = 'none';
            }
        });
        
        // Add event listeners for model checkboxes to update count
        $(document).on('change', '.unified-model-checkbox', function() {
            updateBatchSelectedModelCount();
        });
        
        // Handle provider change to load models dynamically
        $('#batchProvider').on('change', function() {
            loadBatchProviderModels();
        });
        
        // Load models on page load
        loadBatchProviderModels();
    });
    
    function loadBatchProviderModels() {
        const provider = $('#batchProvider').val();
        const modelSelect = $('#batchModel');
        const spinner = $('#batchModelSpinner');
        const status = $('#batchModelLoadingStatus');
        const errorDiv = $('#batchModelError');
        
        // Show loading state
        spinner.show();
        status.text('Loading models...');
        errorDiv.hide();
        modelSelect.prop('disabled', true);
        
        // Clear existing options
        modelSelect.empty();
        modelSelect.append('<option value="">Select a model...</option>');
        
        // Fetch models for the selected provider
        fetch(`/api/models/${provider}`)
            .then(response => response.json())
            .then(data => {
                if (data.popular && data.popular.length > 0) {
                    // Add popular models
                    data.popular.forEach(model => {
                        const displayName = getBatchModelDisplayName(model);
                        modelSelect.append(`<option value="${model}">${displayName}</option>`);
                    });
                    
                    // Add separator if there are other models
                    if (data.other && data.other.length > 0) {
                        modelSelect.append('<option disabled>──────────────</option>');
                        data.other.forEach(model => {
                            const displayName = getBatchModelDisplayName(model);
                            modelSelect.append(`<option value="${model}">${displayName}</option>`);
                        });
                    }
                    
                    status.text('Models loaded successfully');
                } else {
                    status.text('No models available');
                    errorDiv.text('No models available for this provider').show();
                }
            })
            .catch(error => {
                console.error('Error loading models:', error);
                status.text('Error loading models');
                errorDiv.text('Failed to load models. Please try again.').show();
                
                // Add fallback models
                const fallbackModels = getBatchFallbackModels(provider);
                fallbackModels.forEach(model => {
                    modelSelect.append(`<option value="${model.id}">${model.name}</option>`);
                });
            })
            .finally(() => {
                spinner.hide();
                modelSelect.prop('disabled', false);
                setTimeout(() => status.text('Ready'), 2000);
            });
    }
    
    function refreshBatchProviderModels() {
        const provider = $('#batchProvider').val();
        const refreshBtn = $('#refreshBatchModelsBtn');
        const status = $('#batchModelLoadingStatus');
        
        // Show loading state on refresh button
        refreshBtn.prop('disabled', true).find('i').addClass('fa-spin');
        status.text('Refreshing models...');
        
        // Clear cache by making a fresh request
        fetch(`/api/models/${provider}?t=${Date.now()}`)
            .then(response => response.json())
            .then(data => {
                loadBatchProviderModels(); // Reload models
                status.text('Models refreshed successfully');
            })
            .catch(error => {
                console.error('Error refreshing models:', error);
                status.text('Error refreshing models');
            })
            .finally(() => {
                refreshBtn.prop('disabled', false).find('i').removeClass('fa-spin');
                setTimeout(() => status.text('Ready'), 2000);
            });
    }
    
    function getBatchFallbackModels(provider) {
        const fallbackModels = {
            'openrouter': [
                {id: 'anthropic/claude-sonnet-4', name: 'Claude Sonnet 4'},
                {id: 'openai/gpt-4o', name: 'GPT-4o'},
                {id: 'anthropic/claude-3.5-sonnet', name: 'Claude 3.5 Sonnet'}
            ],
            'claude': [
                {id: 'claude-3-5-sonnet-20241022', name: 'Claude 3.5 Sonnet'},
                {id: 'claude-3-opus-20240229', name: 'Claude 3 Opus'},
                {id: 'claude-3-haiku-20240307', name: 'Claude 3 Haiku'}
            ],
            'lm_studio': [
                {id: 'local-model', name: 'Local Model'}
            ]
        };
        return fallbackModels[provider] || [];
    }
    
    function loadBatchAllProvidersModels() {
        // Load all models from all providers for unified selection in batch creation
        const allModelsContainer = document.getElementById('batchAllModelsContainer');
        const providerFilters = document.getElementById('batchProviderFilters');
        
        // Fetch all models
        fetch('/api/models/all')
            .then(response => response.json())
            .then(data => {
                // Clear previous content
                allModelsContainer.innerHTML = '';
                providerFilters.innerHTML = '';
                
                // Create provider filter checkboxes
                const allProviderFilter = document.createElement('div');
                allProviderFilter.className = 'form-check form-check-inline';
                allProviderFilter.innerHTML = `
                    <input class="form-check-input batch-provider-filter" type="checkbox"
                           id="batch-provider-all" value="all" checked>
                    <label class="form-check-label" for="batch-provider-all">
                        <strong>All Providers</strong>
                    </label>
                `;
                providerFilters.appendChild(allProviderFilter);
                
                // Create provider sections
                Object.entries(data).forEach(([providerKey, providerData]) => {
                    // Add provider filter checkbox
                    const providerFilter = document.createElement('div');
                    providerFilter.className = 'form-check form-check-inline';
                    providerFilter.innerHTML = `
                        <input class="form-check-input batch-provider-filter" type="checkbox"
                               id="batch-provider-${providerKey}" value="${providerKey}" checked>
                        <label class="form-check-label" for="batch-provider-${providerKey}">
                            ${getBatchProviderDisplayName(providerKey)}
                        </label>
                    `;
                    providerFilters.appendChild(providerFilter);
                    
                    // Create provider section
                    const providerSection = document.createElement('div');
                    providerSection.className = 'provider-section mb-4';
                    providerSection.setAttribute('data-provider', providerKey);
                    providerSection.innerHTML = `
                        <div class="provider-header d-flex align-items-center mb-2 p-2 bg-light rounded">
                            <input class="form-check-input batch-provider-select-all me-2" type="checkbox"
                                   id="batch-select-all-${providerKey}" checked>
                            <h6 class="mb-0 me-2">
                                <i class="fas fa-${getBatchProviderIcon(providerKey)} me-2"></i>
                                ${getBatchProviderDisplayName(providerKey)}
                            </h6>
                            <span class="badge bg-secondary">${providerData.popular.length} models</span>
                        </div>
                        <div class="models-grid row" id="batch-models-grid-${providerKey}">
                            <!-- Individual model checkboxes will be added here -->
                        </div>
                    `;
                    allModelsContainer.appendChild(providerSection);
                    
                    // Add models to this provider section
                    const modelsGrid = document.getElementById(`batch-models-grid-${providerKey}`);
                    providerData.popular.forEach(model => {
                        const modelId = `batch-${providerKey}-${model.replace(/[^a-zA-Z0-9]/g, '_')}`;
                        const displayName = getBatchModelDisplayName(model);
                        
                        const modelDiv = document.createElement('div');
                        modelDiv.className = 'col-md-6 col-lg-4 mb-2';
                        modelDiv.innerHTML = `
                            <div class="form-check">
                                <input class="form-check-input model-checkbox batch-unified-model-checkbox" type="checkbox"
                                       name="models_to_compare[]" value="${providerKey}:${model}" id="${modelId}">
                                <label class="form-check-label" for="${modelId}">
                                    <span class="model-name">${displayName}</span>
                                    <span class="badge bg-outline-secondary badge-sm">${providerKey}</span>
                                </label>
                            </div>
                        `;
                        modelsGrid.appendChild(modelDiv);
                    });
                });
                
                // Add event listeners for provider filters
                addBatchProviderFilterListeners();
                
                // Add event listeners for provider select-all checkboxes
                addBatchProviderSelectAllListeners();
                
                // Add event listener for model search
                addBatchModelSearchListener();
                
                // Update selected count
                updateBatchSelectedModelCount();
            })
            .catch(error => {
                console.error('Error loading all models for batch:', error);
                document.getElementById('batchAllModelsContainer').innerHTML = '<p class="text-muted">Error loading models</p>';
            });
    }
    
    function addBatchProviderFilterListeners() {
        const providerFilters = document.querySelectorAll('.batch-provider-filter');
        providerFilters.forEach(filter => {
            filter.addEventListener('change', function() {
                const providerKey = this.value;
                const isChecked = this.checked;
                
                if (providerKey === 'all') {
                    // Show/hide all provider sections
                    const allSections = document.querySelectorAll('.provider-section');
                    allSections.forEach(section => {
                        section.style.display = isChecked ? 'block' : 'none';
                    });
                    
                    // Update other checkboxes
                    document.querySelectorAll('.batch-provider-filter:not([value="all"])').forEach(cb => {
                        cb.checked = isChecked;
                    });
                } else {
                    // Show/hide specific provider section
                    const providerSection = document.querySelector(`[data-provider="${providerKey}"]`);
                    if (providerSection) {
                        providerSection.style.display = isChecked ? 'block' : 'none';
                    }
                    
                    // Check if all providers are selected/deselected
                    const allProviderCheckbox = document.getElementById('batch-provider-all');
                    const allProviderFilters = document.querySelectorAll('.batch-provider-filter:not([value="all"])');
                    const allChecked = Array.from(allProviderFilters).every(cb => cb.checked);
                    allProviderCheckbox.checked = allChecked;
                }
            });
        });
    }
    
    function addBatchProviderSelectAllListeners() {
        const selectAllCheckboxes = document.querySelectorAll('.batch-provider-select-all');
        selectAllCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const providerKey = this.getAttribute('id').replace('batch-select-all-', '');
                const isChecked = this.checked;
                const providerSection = document.querySelector(`[data-provider="${providerKey}"]`);
                
                if (providerSection) {
                    const modelCheckboxes = providerSection.querySelectorAll('.batch-unified-model-checkbox');
                    modelCheckboxes.forEach(modelCheckbox => {
                        modelCheckbox.checked = isChecked;
                    });
                }
                
                updateBatchSelectedModelCount();
            });
        });
    }
    
    function addBatchModelSearchListener() {
        const searchInput = document.getElementById('batchModelSearch');
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const modelLabels = document.querySelectorAll('.batch-unified-model-checkbox + label');
            
            modelLabels.forEach(label => {
                const modelName = label.textContent.toLowerCase();
                const modelCheckbox = label.previousElementSibling;
                const providerSection = label.closest('.provider-section');
                
                if (modelName.includes(searchTerm)) {
                    label.style.display = 'block';
                    if (providerSection) {
                        providerSection.style.display = 'block';
                    }
                } else {
                    label.style.display = 'none';
                }
            });
        });
    }
    
    function updateBatchSelectedModelCount() {
        const selectedCheckboxes = document.querySelectorAll('.batch-unified-model-checkbox:checked');
        const count = selectedCheckboxes.length;
        document.getElementById('batchSelectedCount').textContent = count;
        
        // Update the count badge color
        const countBadge = document.getElementById('batchSelectedCount');
        countBadge.className = count >= 2 ? 'badge bg-success' : count === 1 ? 'badge bg-warning' : 'badge bg-secondary';
    }
    
    function clearAllBatchModelSelections() {
        const modelCheckboxes = document.querySelectorAll('.batch-unified-model-checkbox');
        modelCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        updateBatchSelectedModelCount();
    }
    
    function getBatchProviderDisplayName(providerKey) {
        const displayNames = {
            'openrouter': 'OpenRouter',
            'claude': 'Claude',
            'lm_studio': 'LM Studio',
            'ollama': 'Ollama',
            'gemini': 'Gemini',
            'openai': 'OpenAI'
        };
        return displayNames[providerKey] || providerKey;
    }
    
    function getBatchProviderIcon(providerKey) {
        const icons = {
            'openrouter': 'globe',
            'claude': 'robot',
            'lm_studio': 'server',
            'ollama': 'microchip',
            'gemini': 'gem',
            'openai': 'bolt'
        };
        return icons[providerKey] || 'question';
    }
    
    function getBatchModelDisplayName(modelName) {
        // Create a more readable display name from the model identifier
        const nameMap = {
            'anthropic/claude-opus-4-1': 'Claude Opus 4.1 (Latest)',
            'openai/gpt-5': 'GPT-5',
            'openai/gpt-4o': 'GPT-4o',
            'openai/gpt-4o-mini': 'GPT-4o Mini',
            'anthropic/claude-3-opus-20240229': 'Claude 3 Opus',
            'meta-llama/llama-3.1-70b-instruct': 'Llama 3.1 70B',
            'google/gemini-2.5-pro': 'Gemini 2.5 Pro (Latest)',
            'google/gemini-pro-1.5': 'Gemini Pro 1.5',
            'mistralai/mistral-7b-instruct': 'Mistral 7B',
            'openai/gpt-4-turbo': 'GPT-4 Turbo',
            'anthropic/claude-3-haiku-20240307': 'Claude 3 Haiku',
            'claude-4-opus-20250805': 'Claude 4 Opus (Latest)',
            'claude-3-5-sonnet-20241022': 'Claude 3.5 Sonnet',
            'claude-3-opus-20240229': 'Claude 3 Opus',
            'claude-3-sonnet-20240229': 'Claude 3 Sonnet',
            'claude-3-haiku-20240307': 'Claude 3 Haiku',
            'local-model': 'Local Model',
            'llama-3.1-70b-instruct': 'Llama 3.1 70B',
            'mistral-7b-instruct': 'Mistral 7B',
            'codellama-34b-instruct': 'Code Llama 34B'
        };
        
        return nameMap[modelName] || modelName;
    }

        // Handle clear filters button
        $('#clearFilters').on('click', function() {
            window.location.search = ''; // Clear all query params
        });

        // Handle create batch form submission
        $('#createBatchForm').on('submit', function(e) {
            e.preventDefault();
            const form = $(this);
            const batchName = $('#batchName').val();
            const description = $('#batchDescription').val();
            const templateId = $('#batchTemplate').val();
            const provider = $('#batchProvider').val();
            const model = $('#batchModel').val();
            const temperature = parseFloat($('#batchTemperature').val());
            const maxTokens = parseInt($('#batchMaxTokens').val());
            const priority = parseInt($('#batchPriority').val());
            const prompt = $('#batchPrompt').val();
            const savedPromptId = $('#batchSavedPrompt').val();
            const savedMarkingSchemeId = $('#batchSavedMarkingScheme').val();
            const tags = $('#batchTags').val().split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
            const deadline = $('#batchDeadline').val();
            const autoAssignJobs = $('#autoAssignJobs').prop('checked');
            
            // Collect selected models for multi-model comparison
            const selectedModels = [];
            $('input[name="models_to_compare[]"]:checked').each(function() {
                selectedModels.push($(this).val());
            });

            $.ajax({
                url: '{{ url_for("create_batch") }}',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    batch_name: batchName,
                    description: description,
                    template_id: templateId,
                    provider: provider,
                    model: model,
                    temperature: temperature,
                    max_tokens: maxTokens,
                    priority: priority,
                    prompt: prompt,
                    saved_prompt_id: savedPromptId,
                    saved_marking_scheme_id: savedMarkingSchemeId,
                    tags: tags,
                    deadline: deadline,
                    auto_assign_jobs: autoAssignJobs,
                    models_to_compare: selectedModels.length > 0 ? selectedModels : null
                }),
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        window.location.reload(); // Reload to show new batch
                    } else {
                        alert('Error: ' + response.error);
                    }
                },
                error: function(xhr) {
                    alert('Error creating batch: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
                }
            });
        });

        // Apply template settings when template is selected
        $('#batchTemplate').on('change', function() {
            const selectedOption = $(this).find('option:selected');
            const defaultSettings = selectedOption.data('settings');
            const jobStructure = selectedOption.data('job-structure');
            const processingRules = selectedOption.data('processing-rules');

            if (defaultSettings) {
                // Apply default settings
                if (defaultSettings.provider) {
                    $('#batchProvider').val(defaultSettings.provider);
                }
                if (defaultSettings.model) {
                    $('#batchModel').val(defaultSettings.model);
                }
                if (defaultSettings.temperature !== undefined) {
                    $('#batchTemperature').val(defaultSettings.temperature);
                }
                if (defaultSettings.max_tokens !== undefined) {
                    $('#batchMaxTokens').val(defaultSettings.max_tokens);
                }
                
                // Apply job structure settings
                if (jobStructure) {
                    if (jobStructure.auto_create_jobs !== undefined) {
                        $('#autoAssignJobs').prop('checked', jobStructure.auto_create_jobs);
                    }
                    if (jobStructure.default_priority !== undefined) {
                        $('#batchPriority').val(jobStructure.default_priority);
                    }
                }
                
                // Apply processing rules
                if (processingRules) {
                    // Could add processing rule application here if needed
                    console.log('Processing rules available:', processingRules);
                }
                
                // Show template applied notification
                showTemplateNotification('Template settings applied successfully');
                
            } else {
                // Reset to default if "No Template" is selected
                $('#batchProvider').val('openrouter');
                $('#batchModel').val('');
                $('#batchTemperature').val('0.3');
                $('#batchMaxTokens').val('2000');
                $('#batchPriority').val('5');
                $('#autoAssignJobs').prop('checked', false);
            }
        });
        
        function showTemplateNotification(message) {
            // Create and show a temporary notification
            const notification = $(`
                <div class="alert alert-info alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 1050; min-width: 300px;">
                    <i class="fas fa-check-circle me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);
            
            $('body').append(notification);
            
            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                notification.alert('close');
            }, 3000);
        }

        // Handle multi-model comparison toggle
        $('#enableMultiModelComparison').on('change', function() {
            if ($(this).is(':checked')) {
                $('#multiModelSection').show();
                loadBatchPopularModels();
            } else {
                $('#multiModelSection').hide();
                // Uncheck all model selections
                $('input[name="models_to_compare[]"]').prop('checked', false);
            }
        });
        
        // Load popular models for batch multi-model comparison
        function loadBatchPopularModels() {
            const batchPopularModelsDiv = document.getElementById('batchPopularModels');
            batchPopularModelsDiv.innerHTML = '<p class="text-muted">Loading models...</p>';
            
            fetch('/api/models/openrouter')
                .then(response => response.json())
                .then(data => {
                    batchPopularModelsDiv.innerHTML = '';
                    
                    if (data.popular && data.popular.length > 0) {
                        data.popular.forEach(model => {
                            // prefix values with provider and make ids unique
                            const provider = 'openrouter';
                            const modelId = (provider + '_' + model).replace(/[^a-zA-Z0-9]/g, '_');
                            const displayName = getBatchModelDisplayName(model);
                            
                            const div = document.createElement('div');
                            div.className = 'form-check';
                            div.innerHTML = `
                                <input class="form-check-input model-checkbox" type="checkbox" 
                                       name="models_to_compare[]" value="${provider}:${model}" id="${modelId}">
                                <label class="form-check-label" for="${modelId}">
                                    ${displayName}
                                </label>
                            `;
                            batchPopularModelsDiv.appendChild(div);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading models:', error);
                    batchPopularModelsDiv.innerHTML = '<p class="text-muted">Error loading models</p>';
                });
        }
        
        function getBatchModelDisplayName(modelName) {
            // Create a more readable display name from the model identifier
            const nameMap = {
                'anthropic/claude-opus-4-1': 'Claude Opus 4.1 (Latest)',
                'openai/gpt-5': 'GPT-5',
                'openai/gpt-4o': 'GPT-4o',
                'openai/gpt-4o-mini': 'GPT-4o Mini',
                'anthropic/claude-3-opus-20240229': 'Claude 3 Opus',
                'meta-llama/llama-3.1-70b-instruct': 'Llama 3.1 70B',
                'google/gemini-2.5-pro': 'Gemini 2.5 Pro (Latest)',
                'google/gemini-pro-1.5': 'Gemini Pro 1.5',
                'mistralai/mistral-7b-instruct': 'Mistral 7B',
                'openai/gpt-4-turbo': 'GPT-4 Turbo',
                'anthropic/claude-3-haiku-20240307': 'Claude 3 Haiku'
            };
            
            return nameMap[modelName] || modelName;
        }

        // Handle batch action buttons (start, pause, resume, cancel, retry, duplicate, delete, archive)
        $('#batches-table-body').on('click', '.start-batch-btn, .pause-batch-btn, .resume-batch-btn, .cancel-batch-btn, .retry-batch-btn, .duplicate-batch-btn, .delete-batch-btn, .archive-batch-btn', function() {
            const batchId = $(this).data('id');
            let action = '';
            let confirmMessage = '';
            let apiUrl = '';

            if ($(this).hasClass('start-batch-btn')) {
                action = 'start';
                confirmMessage = 'Are you sure you want to start this batch?';
                apiUrl = `/api/batches/${batchId}/start`;
            } else if ($(this).hasClass('pause-batch-btn')) {
                action = 'pause';
                confirmMessage = 'Are you sure you want to pause this batch?';
                apiUrl = `/api/batches/${batchId}/pause`;
            } else if ($(this).hasClass('resume-batch-btn')) {
                action = 'resume';
                confirmMessage = 'Are you sure you want to resume this batch?';
                apiUrl = `/api/batches/${batchId}/resume`;
            } else if ($(this).hasClass('cancel-batch-btn')) {
                action = 'cancel';
                confirmMessage = 'Are you sure you want to cancel this batch? This action cannot be undone.';
                apiUrl = `/api/batches/${batchId}/cancel`;
            } else if ($(this).hasClass('retry-batch-btn')) {
                action = 'retry';
                confirmMessage = 'Are you sure you want to retry all failed jobs in this batch?';
                apiUrl = `/api/batches/${batchId}/retry`;
            } else if ($(this).hasClass('duplicate-batch-btn')) {
                action = 'duplicate';
                confirmMessage = 'Enter new name for the duplicated batch:';
                const newName = prompt(confirmMessage);
                if (newName === null) return; // User cancelled
                apiUrl = `/api/batches/${batchId}/duplicate`;
                sendActionRequest(apiUrl, { new_name: newName });
                return;
            } else if ($(this).hasClass('delete-batch-btn')) {
                action = 'delete';
                confirmMessage = 'Are you sure you want to delete this batch? This action cannot be undone.';
                apiUrl = `/api/batches/${batchId}`;
                sendActionRequest(apiUrl, {}, 'DELETE');
                return;
            } else if ($(this).hasClass('archive-batch-btn')) {
                action = 'archive';
                confirmMessage = 'Are you sure you want to archive this batch?';
                apiUrl = `/api/batches/${batchId}/archive`;
            }

            if (confirm(confirmMessage)) {
                sendActionRequest(apiUrl, {});
            }
        });

        function sendActionRequest(url, data, method = 'POST') {
            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        window.location.reload(); // Reload to update batch list/status
                    } else {
                        alert('Error: ' + response.error);
                    }
                },
                error: function(xhr) {
                    alert('Error performing action: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
                }
            });
        }
    });
</script>
{% endblock %}
