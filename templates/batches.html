{% extends "base.html" %}

{% block title %}Batches{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Batch Management</h1>
    <p>This page will display the list of batches and allow for their management.</p>
    
    <div id="loading" style="display: none;">Loading batches...</div>
    <div id="error" class="alert alert-danger" style="display: none;"></div>

    <!-- Filtering and Search Controls -->
    <div class="card mb-3">
        <div class="card-header">Filter Batches</div>
        <div class="card-body">
            <form id="filterForm" class="row g-3">
                <div class="col-md-3">
                    <label for="statusFilter" class="form-label">Status</label>
                    <select class="form-select" id="statusFilter" name="status">
                        <option value="all">All</option>
                        {% for status in filter_options.statuses %}
                        <option value="{{ status }}" {% if current_filters.status == status %}selected{% endif %}>{{ status | title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="priorityFilter" class="form-label">Priority</label>
                    <select class="form-select" id="priorityFilter" name="priority">
                        <option value="all">All</option>
                        {% for priority in filter_options.priorities %}
                        <option value="{{ priority }}" {% if current_filters.priority and current_filters.priority == priority|string %}selected{% endif %}>{{ priority }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="tagFilter" class="form-label">Tag</label>
                    <select class="form-select" id="tagFilter" name="tag">
                        <option value="">All</option>
                        {% for tag in filter_options.tags %}
                        <option value="{{ tag }}" {% if current_filters.tag == tag %}selected{% endif %}>{{ tag }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="searchFilter" class="form-label">Search</label>
                    <input type="text" class="form-control" id="searchFilter" name="search" value="{{ current_filters.search }}" placeholder="Search by name or description">
                </div>
                <div class="col-12 mt-3">
                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                    <button type="button" class="btn btn-secondary" id="clearFilters">Clear Filters</button>
                </div>
            </form>
        </div>
    </div>

    <h2 class="mt-4">Batches</h2>
    <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#createBatchModal">Create New Batch</button>
    
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Status</th>
                    <th>Progress</th>
                    <th>Jobs (C/F/T)</th>
                    <th>Last Updated</th>
                    <th>Actions</th>
                </tr>
            </thead&gt>
            <tbody id="batches-table-body">
                {% if batches %}
                    {% for batch in batches %}
                    <tr>
                        <td><a href="{{ url_for('batch_detail', batch_id=batch.id) }}">{{ batch.batch_name }}</a></td>
                        <td>
                            <span class="badge bg-{{ {
                                'draft': 'secondary',
                                'pending': 'info',
                                'processing': 'primary',
                                'paused': 'warning',
                                'completed': 'success',
                                'completed_with_errors': 'warning',
                                'failed': 'danger',
                                'cancelled': 'dark',
                                'archived': 'light'
                            }[batch.status] }}">{{ batch.status | title }}</span>
                        </td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar {% if batch.status == 'failed' %}bg-danger{% elif batch.status == 'completed' %}bg-success{% elif batch.progress > 0 %}bg-info{% else %}bg-secondary{% endif %}" role="progressbar" style="width: {{ batch.progress }}%;" aria-valuenow="{{ batch.progress }}" aria-valuemin="0" aria-valuemax="100">{{ batch.progress }}%</div>
                            </div>
                        </td>
                        <td>
                            {{ batch.completed_jobs }}/{{ batch.failed_jobs }}/{{ batch.total_jobs }}
                            {% if batch.status in ['draft', 'pending', 'paused'] %}
                            <br><small class="text-success"><i class="fas fa-plus-circle me-1"></i>Can add jobs</small>
                            {% endif %}
                        </td>
                        <td>{{ batch.updated_at[:16].replace('T', ' ') if batch.updated_at else 'N/A' }}</td>
                        <td>
                            <div class="d-flex">
                                <!-- Action Buttons -->
                                {% if batch.can_start %}
                                <button class="btn btn-sm btn-primary me-1 start-batch-btn" data-id="{{ batch.id }}">Start</button>
                                {% endif %}
                                {% if batch.can_pause %}
                                <button class="btn btn-sm btn-warning me-1 pause-batch-btn" data-id="{{ batch.id }}">Pause</button>
                                {% endif %}
                                {% if batch.can_resume %}
                                <button class="btn btn-sm btn-info me-1 resume-batch-btn" data-id="{{ batch.id }}">Resume</button>
                                {% endif %}
                                {% if batch.can_retry %}
                                <button class="btn btn-sm btn-secondary me-1 retry-batch-btn" data-id="{{ batch.id }}">Retry Failed</button>
                                {% endif %}
                                <button class="btn btn-sm btn-danger me-1 delete-batch-btn" data-id="{{ batch.id }}">Delete</button>
                                <button class="btn btn-sm btn-secondary me-1 duplicate-batch-btn" data-id="{{ batch.id }}">Duplicate</button>
                                <a href="{{ url_for('api_export_batch', batch_id=batch.id) }}" class="btn btn-sm btn-light me-1">Export</a>
                                <button class="btn btn-sm btn-dark archive-batch-btn" data-id="{{ batch.id }}">Archive</button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                <tr><td colspan="6" class="text-center">No batches found.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Create Batch Modal -->
<div class="modal fade" id="createBatchModal" tabindex="-1" aria-labelledby="createBatchModalLabel" aria-hidden="true" data-bs-backdrop="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createBatchModalLabel">Create New Batch</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createBatchForm">
                    <div class="mb-3">
                        <label for="batchName" class="form-label">Batch Name</label>
                        <input type="text" class="form-control" id="batchName" name="batch_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="batchDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="batchDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="batchTemplate" class="form-label">Select Template (Optional)</label>
                        <select class="form-select" id="batchTemplate" name="template_id">
                            <option value="">No Template</option>
                            {% for template in templates %}
                            <option value="{{ template.id }}" data-settings="{{ template.default_settings | tojson }}">{{ template.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="batchProvider" class="form-label">Default Provider</label>
                            <select class="form-select" id="batchProvider" name="provider">
                                <option value="openrouter">OpenRouter</option>
                                <option value="claude">Claude</option>
                                <option value="lm_studio">LM Studio</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="batchModel" class="form-label">Default Model</label>
                            <input type="text" class="form-control" id="batchModel" name="model" placeholder="e.g., anthropic/claude-sonnet-4">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="batchTemperature" class="form-label">Temperature</label>
                            <input type="number" step="0.1" min="0" max="1" class="form-control" id="batchTemperature" name="temperature" value="0.3">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="batchMaxTokens" class="form-label">Max Tokens</label>
                            <input type="number" class="form-control" id="batchMaxTokens" name="max_tokens" value="2000">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="batchPriority" class="form-label">Priority (1-10)</label>
                        <input type="number" class="form-control" id="batchPriority" name="priority" min="1" max="10" value="5">
                    </div>
                    <div class="mb-3">
                        <label for="batchPrompt" class="form-label">Default Prompt (Optional)</label>
                        <textarea class="form-control" id="batchPrompt" name="prompt" rows="3" placeholder="Default prompt for all jobs in this batch"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="batchSavedPrompt" class="form-label">Saved Prompt (Optional)</label>
                            <select class="form-select" id="batchSavedPrompt" name="saved_prompt_id">
                                <option value="">No saved prompt</option>
                                {% for prompt in saved_prompts %}
                                <option value="{{ prompt.id }}">{{ prompt.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="batchSavedMarkingScheme" class="form-label">Saved Marking Scheme (Optional)</label>
                            <select class="form-select" id="batchSavedMarkingScheme" name="saved_marking_scheme_id">
                                <option value="">No saved marking scheme</option>
                                {% for scheme in saved_marking_schemes %}
                                <option value="{{ scheme.id }}">{{ scheme.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enableMultiModelComparison" name="enable_multi_model_comparison">
                            <label class="form-check-label" for="enableMultiModelComparison">
                                Enable multi-model comparison for batch
                            </label>
                        </div>
                        <small class="form-text text-muted">When enabled, jobs in this batch will run against multiple AI models for comparison</small>
                    </div>
                    
                    <!-- Multi-model selection section -->
                    <div id="multiModelSection" style="display: none;" class="mb-3">
                        <label class="form-label">Select Models to Compare</label>
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-muted">OpenRouter Models</h6>
                                <div id="batchPopularModels">
                                    <!-- Popular models will be loaded here -->
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted">Other Providers</h6>
                                <div class="form-check">
                                    <input class="form-check-input model-checkbox" type="checkbox" 
                                           name="models_to_compare[]" value="claude-4-opus-20250805" id="batch_claude_direct">
                                    <label class="form-check-label" for="batch_claude_direct">
                                        Claude 3.5 Sonnet (Direct API)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input model-checkbox" type="checkbox" 
                                           name="models_to_compare[]" value="local-model" id="batch_lm_studio">
                                    <label class="form-check-label" for="batch_lm_studio">
                                        LM Studio (Local)
                                    </label>
                                </div>
                            </div>
                        </div>
                        <small class="form-text text-muted">Select 2 or more models to enable comparison. Individual jobs can override these settings.</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="batchTags" class="form-label">Tags (comma-separated)</label>
                        <input type="text" class="form-control" id="batchTags" name="tags" placeholder="e.g., academic, research">
                    </div>
                    <div class="mb-3">
                        <label for="batchDeadline" class="form-label">Deadline (Optional)</label>
                        <input type="datetime-local" class="form-control" id="batchDeadline" name="deadline">
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="autoAssignJobs" name="auto_assign_jobs">
                        <label class="form-check-label" for="autoAssignJobs">
                            Auto-assign jobs (automatically add new uploads to this batch)
                        </label>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Create Batch</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Handle filter form submission
        $('#filterForm').on('submit', function(e) {
            e.preventDefault();
            const formData = new URLSearchParams($(this).serialize()).toString();
            window.location.search = formData; // Reload page with filters
        });

        // Handle clear filters button
        $('#clearFilters').on('click', function() {
            window.location.search = ''; // Clear all query params
        });

        // Handle create batch form submission
        $('#createBatchForm').on('submit', function(e) {
            e.preventDefault();
            const form = $(this);
            const batchName = $('#batchName').val();
            const description = $('#batchDescription').val();
            const templateId = $('#batchTemplate').val();
            const provider = $('#batchProvider').val();
            const model = $('#batchModel').val();
            const temperature = parseFloat($('#batchTemperature').val());
            const maxTokens = parseInt($('#batchMaxTokens').val());
            const priority = parseInt($('#batchPriority').val());
            const prompt = $('#batchPrompt').val();
            const savedPromptId = $('#batchSavedPrompt').val();
            const savedMarkingSchemeId = $('#batchSavedMarkingScheme').val();
            const tags = $('#batchTags').val().split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
            const deadline = $('#batchDeadline').val();
            const autoAssignJobs = $('#autoAssignJobs').prop('checked');
            
            // Collect selected models for multi-model comparison
            const selectedModels = [];
            $('input[name="models_to_compare[]"]:checked').each(function() {
                selectedModels.push($(this).val());
            });

            $.ajax({
                url: '{{ url_for("create_batch") }}',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    batch_name: batchName,
                    description: description,
                    template_id: templateId,
                    provider: provider,
                    model: model,
                    temperature: temperature,
                    max_tokens: maxTokens,
                    priority: priority,
                    prompt: prompt,
                    saved_prompt_id: savedPromptId,
                    saved_marking_scheme_id: savedMarkingSchemeId,
                    tags: tags,
                    deadline: deadline,
                    auto_assign_jobs: autoAssignJobs,
                    models_to_compare: selectedModels.length > 0 ? selectedModels : null
                }),
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        window.location.reload(); // Reload to show new batch
                    } else {
                        alert('Error: ' + response.error);
                    }
                },
                error: function(xhr) {
                    alert('Error creating batch: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
                }
            });
        });

        // Apply template settings when template is selected
        $('#batchTemplate').on('change', function() {
            const selectedOption = $(this).find('option:selected');
            const defaultSettings = selectedOption.data('settings');

            if (defaultSettings) {
                if (defaultSettings.provider) {
                    $('#batchProvider').val(defaultSettings.provider);
                }
                if (defaultSettings.model) {
                    $('#batchModel').val(defaultSettings.model);
                }
                if (defaultSettings.temperature !== undefined) {
                    $('#batchTemperature').val(defaultSettings.temperature);
                }
                if (defaultSettings.max_tokens !== undefined) {
                    $('#batchMaxTokens').val(defaultSettings.max_tokens);
                }
            } else {
                // Reset to default if "No Template" is selected
                $('#batchProvider').val('openrouter');
                $('#batchModel').val('');
                $('#batchTemperature').val('0.3');
                $('#batchMaxTokens').val('2000');
            }
        });

        // Handle multi-model comparison toggle
        $('#enableMultiModelComparison').on('change', function() {
            if ($(this).is(':checked')) {
                $('#multiModelSection').show();
                loadBatchPopularModels();
            } else {
                $('#multiModelSection').hide();
                // Uncheck all model selections
                $('input[name="models_to_compare[]"]').prop('checked', false);
            }
        });
        
        // Load popular models for batch multi-model comparison
        function loadBatchPopularModels() {
            const batchPopularModelsDiv = document.getElementById('batchPopularModels');
            batchPopularModelsDiv.innerHTML = '<p class="text-muted">Loading models...</p>';
            
            fetch('/api/models/openrouter')
                .then(response => response.json())
                .then(data => {
                    batchPopularModelsDiv.innerHTML = '';
                    
                    if (data.popular && data.popular.length > 0) {
                        data.popular.forEach(model => {
                            const modelId = 'batch_' + model.replace(/[^a-zA-Z0-9]/g, '_');
                            const displayName = getBatchModelDisplayName(model);
                            
                            const div = document.createElement('div');
                            div.className = 'form-check';
                            div.innerHTML = `
                                <input class="form-check-input model-checkbox" type="checkbox" 
                                       name="models_to_compare[]" value="${model}" id="${modelId}">
                                <label class="form-check-label" for="${modelId}">
                                    ${displayName}
                                </label>
                            `;
                            batchPopularModelsDiv.appendChild(div);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading models:', error);
                    batchPopularModelsDiv.innerHTML = '<p class="text-muted">Error loading models</p>';
                });
        }
        
        function getBatchModelDisplayName(modelName) {
            // Create a more readable display name from the model identifier
            const nameMap = {
                'anthropic/claude-opus-4-1': 'Claude Opus 4.1 (Latest)',
                'openai/gpt-5': 'GPT-5',
                'openai/gpt-4o': 'GPT-4o',
                'openai/gpt-4o-mini': 'GPT-4o Mini',
                'anthropic/claude-3-opus-20240229': 'Claude 3 Opus',
                'meta-llama/llama-3.1-70b-instruct': 'Llama 3.1 70B',
                'google/gemini-2.5-pro': 'Gemini 2.5 Pro (Latest)',
                'google/gemini-pro-1.5': 'Gemini Pro 1.5',
                'mistralai/mistral-7b-instruct': 'Mistral 7B',
                'openai/gpt-4-turbo': 'GPT-4 Turbo',
                'anthropic/claude-3-haiku-20240307': 'Claude 3 Haiku'
            };
            
            return nameMap[modelName] || modelName;
        }

        // Handle batch action buttons (start, pause, resume, cancel, retry, duplicate, delete, archive)
        $('#batches-table-body').on('click', '.start-batch-btn, .pause-batch-btn, .resume-batch-btn, .cancel-batch-btn, .retry-batch-btn, .duplicate-batch-btn, .delete-batch-btn, .archive-batch-btn', function() {
            const batchId = $(this).data('id');
            let action = '';
            let confirmMessage = '';
            let apiUrl = '';

            if ($(this).hasClass('start-batch-btn')) {
                action = 'start';
                confirmMessage = 'Are you sure you want to start this batch?';
                apiUrl = `/api/batches/${batchId}/start`;
            } else if ($(this).hasClass('pause-batch-btn')) {
                action = 'pause';
                confirmMessage = 'Are you sure you want to pause this batch?';
                apiUrl = `/api/batches/${batchId}/pause`;
            } else if ($(this).hasClass('resume-batch-btn')) {
                action = 'resume';
                confirmMessage = 'Are you sure you want to resume this batch?';
                apiUrl = `/api/batches/${batchId}/resume`;
            } else if ($(this).hasClass('cancel-batch-btn')) {
                action = 'cancel';
                confirmMessage = 'Are you sure you want to cancel this batch? This action cannot be undone.';
                apiUrl = `/api/batches/${batchId}/cancel`;
            } else if ($(this).hasClass('retry-batch-btn')) {
                action = 'retry';
                confirmMessage = 'Are you sure you want to retry all failed jobs in this batch?';
                apiUrl = `/api/batches/${batchId}/retry`;
            } else if ($(this).hasClass('duplicate-batch-btn')) {
                action = 'duplicate';
                confirmMessage = 'Enter new name for the duplicated batch:';
                const newName = prompt(confirmMessage);
                if (newName === null) return; // User cancelled
                apiUrl = `/api/batches/${batchId}/duplicate`;
                sendActionRequest(apiUrl, { new_name: newName });
                return;
            } else if ($(this).hasClass('delete-batch-btn')) {
                action = 'delete';
                confirmMessage = 'Are you sure you want to delete this batch? This action cannot be undone.';
                apiUrl = `/api/batches/${batchId}`;
                sendActionRequest(apiUrl, {}, 'DELETE');
                return;
            } else if ($(this).hasClass('archive-batch-btn')) {
                action = 'archive';
                confirmMessage = 'Are you sure you want to archive this batch?';
                apiUrl = `/api/batches/${batchId}/archive`;
            }

            if (confirm(confirmMessage)) {
                sendActionRequest(apiUrl, {});
            }
        });

        function sendActionRequest(url, data, method = 'POST') {
            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        window.location.reload(); // Reload to update batch list/status
                    } else {
                        alert('Error: ' + response.error);
                    }
                },
                error: function(xhr) {
                    alert('Error performing action: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
                }
            });
        }
    });
</script>
{% endblock %}