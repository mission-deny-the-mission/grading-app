{% extends "base.html" %}

{% block title %}Grade Submission - Document Grading App{% endblock %}

{% block content %}
<div class="main-container">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <a href="javascript:history.back()" class="text-muted text-decoration-none small mb-3 d-inline-block">
                <i class="fas fa-arrow-left me-2"></i>Back
            </a>
            <h1 class="mb-2">Grade Submission</h1>
            <p class="text-muted">Apply grading scheme and enter grades for each criterion</p>
        </div>
        <div id="scoreDisplay" class="text-center">
            <div class="display-4 text-primary" id="totalScore">0</div>
            <small class="text-muted" id="maxScore">/ 0 points</small>
        </div>
    </div>

    <!-- Submission Info (placeholder) -->
    <div class="card mb-4" id="submissionInfo">
        <div class="card-body">
            <div id="loadingSpinner" class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading submission...</span>
                </div>
                <p class="mt-2 text-muted">Loading submission details...</p>
            </div>
        </div>
    </div>

    <!-- Grading Form -->
    <form id="gradingForm" class="d-none">
        <!-- Questions and Criteria -->
        <div id="gradingContent"></div>

        <!-- Action Buttons -->
        <div class="d-flex gap-2 mt-4">
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-save me-2"></i>Save Grades
            </button>
            <button type="button" class="btn btn-outline-secondary btn-lg" id="draftBtn">
                <i class="fas fa-clock me-2"></i>Save as Draft
            </button>
            <a href="javascript:history.back()" class="btn btn-outline-danger btn-lg">
                <i class="fas fa-times me-2"></i>Cancel
            </a>
        </div>
    </form>

    <!-- No Scheme State -->
    <div id="noSchemeContent" style="display: none;">
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>No grading scheme selected.</strong> Please select a grading scheme to apply.
        </div>
        <a href="javascript:history.back()" class="btn btn-secondary">Back to Submission</a>
    </div>
</div>

<script>
class GradingInterface {
    constructor() {
        this.submissionId = new URLSearchParams(window.location.search).get('submission_id');
        this.schemeId = new URLSearchParams(window.location.search).get('scheme_id');
        this.draftMode = false;

        this.form = document.getElementById('gradingForm');
        this.draftBtn = document.getElementById('draftBtn');
        this.submissionInfo = document.getElementById('submissionInfo');
        this.gradingContent = document.getElementById('gradingContent');
        this.noSchemeContent = document.getElementById('noSchemeContent');

        this.form.addEventListener('submit', (e) => this.handleSubmit(e, false));
        this.draftBtn.addEventListener('click', (e) => this.handleDraftSubmit(e));

        this.init();
    }

    async init() {
        if (!this.schemeId) {
            this.noSchemeContent.style.display = 'block';
            return;
        }

        try {
            // Load scheme
            const schemeResponse = await fetch(`/api/schemes/${this.schemeId}`);
            if (!schemeResponse.ok) throw new Error('Failed to load scheme');
            const scheme = await schemeResponse.json();

            // Render grading form
            this.renderGradingForm(scheme);

            // Update display
            this.submissionInfo.innerHTML = `
                <div class="row align-items-center">
                    <div class="col">
                        <h6 class="mb-1">Grading Scheme</h6>
                        <p class="mb-0"><strong>${scheme.name}</strong></p>
                    </div>
                    <div class="col-auto">
                        <span class="badge bg-primary">${scheme.total_possible_points} points</span>
                    </div>
                </div>
            `;

            document.getElementById('maxScore').textContent = `/ ${scheme.total_possible_points} points`;
            this.form.classList.remove('d-none');

        } catch (error) {
            console.error('Error loading scheme:', error);
            this.submissionInfo.innerHTML = `
                <div class="alert alert-danger mb-0">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Error loading scheme: ${error.message}
                </div>
            `;
        }
    }

    renderGradingForm(scheme) {
        let html = '';

        scheme.questions.forEach((question, qIndex) => {
            html += `
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <div class="d-flex justify-content-between">
                            <h6 class="mb-0">
                                <span class="badge bg-secondary me-2">${qIndex + 1}</span>
                                ${question.title}
                            </h6>
                            <span class="badge bg-info question-points" data-question-id="${question.id}">
                                ${question.total_possible_points} pts
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        ${question.description ? `<p class="text-muted mb-3">${question.description}</p>` : ''}

                        <!-- Criteria Input -->
                        <div class="criteria-inputs" data-question-id="${question.id}">
                            ${question.criteria.map((criterion, cIndex) => `
                                <div class="card card-sm mb-3 bg-light">
                                    <div class="card-body">
                                        <div class="row mb-2">
                                            <div class="col">
                                                <label class="form-label"><strong>${criterion.name}</strong></label>
                                                ${criterion.description ? `<small class="text-muted d-block mb-2">${criterion.description}</small>` : ''}
                                            </div>
                                            <div class="col-auto">
                                                <span class="badge bg-success">Max: ${criterion.max_points}</span>
                                            </div>
                                        </div>
                                        <div class="row g-2">
                                            <div class="col-md-8">
                                                <input type="number"
                                                       class="form-control criterion-score"
                                                       min="0"
                                                       max="${criterion.max_points}"
                                                       step="0.5"
                                                       placeholder="Points earned"
                                                       data-criterion-id="${criterion.id}"
                                                       data-max-points="${criterion.max_points}">
                                            </div>
                                            <div class="col-md-4">
                                                <input type="text"
                                                       class="form-control criterion-percent"
                                                       readonly
                                                       placeholder="0%"
                                                       style="background-color: #f8f9fa;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <!-- Feedback -->
                        <div class="mt-3">
                            <label class="form-label">Feedback for this question (Optional)</label>
                            <textarea class="form-control feedback-textarea"
                                      rows="3"
                                      placeholder="Provide constructive feedback to the student..."
                                      data-question-id="${question.id}"></textarea>
                        </div>
                    </div>
                </div>
            `;
        });

        this.gradingContent.innerHTML = html;

        // Attach event listeners
        this.gradingContent.querySelectorAll('.criterion-score').forEach(input => {
            input.addEventListener('input', (e) => this.updateScore());
        });
    }

    updateScore() {
        let total = 0;
        let max = 0;

        document.querySelectorAll('.criterion-score').forEach(input => {
            const score = parseFloat(input.value) || 0;
            const maxPoints = parseFloat(input.dataset.maxPoints) || 0;

            // Update percentage indicator
            const percent = maxPoints > 0 ? Math.round((score / maxPoints) * 100) : 0;
            const percentInput = input.closest('.card').querySelector('.criterion-percent');
            if (percentInput) {
                percentInput.value = `${percent}%`;
            }

            total += score;
            max += maxPoints;
        });

        document.getElementById('totalScore').textContent = total.toFixed(1);
    }

    async handleSubmit(e, draft = false) {
        e.preventDefault();

        const evaluations = [];

        document.querySelectorAll('.criteria-inputs').forEach(container => {
            const questionId = container.dataset.questionId;

            container.querySelectorAll('.criterion-score').forEach(input => {
                const criterionId = input.dataset.criterionId;
                const score = parseFloat(input.value) || 0;
                const feedback = input.closest('[data-question-id]')
                    ?.querySelector('.feedback-textarea')?.value || '';

                evaluations.push({
                    criterion_id: criterionId,
                    points_earned: score,
                    feedback: feedback
                });
            });
        });

        // Validate
        if (evaluations.some(e => e.points_earned < 0)) {
            ui.error('Points cannot be negative');
            return;
        }

        ui.showLoading(draft ? 'Saving draft...' : 'Submitting grades...');

        try {
            // Save to API
            const response = await fetch(`/api/submissions/${this.submissionId}/grade`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    scheme_id: this.schemeId,
                    evaluations: evaluations,
                    is_complete: !draft
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || 'Failed to save grades');
            }

            ui.success(`Grades ${draft ? 'saved as draft' : 'submitted'} successfully!`);

            // Delay navigation to show success message
            setTimeout(() => {
                window.history.back();
            }, 1000);

        } catch (error) {
            console.error('Error saving grades:', error);
            ui.error(`Failed to save grades: ${error.message}`);
        } finally {
            ui.hideLoading();
        }
    }

    async handleDraftSubmit(e) {
        e.preventDefault();
        this.draftMode = true;
        await this.handleSubmit({ preventDefault: () => {} }, true);
    }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    new GradingInterface();
});
</script>

<style>
    .card-sm {
        border: 1px solid #e9ecef;
        border-radius: 0.5rem;
    }

    .criterion-percent {
        text-align: right;
        font-weight: 600;
        color: #667eea;
    }

    @media print {
        .btn, button[type="submit"], a.btn {
            display: none;
        }
    }
</style>
{% endblock %}
