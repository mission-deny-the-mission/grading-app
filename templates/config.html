{% extends "base.html" %} {% block title %}Configuration - Document Grader{%
endblock %} {% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="text-center mb-4">
            <h1 class="display-4 fw-bold text-primary mb-3">
                <i class="fas fa-cog me-3"></i>
                Configuration Settings
            </h1>
            <p class="lead text-muted">
                Configure your API keys and default settings for the document
                grading system
            </p>
        </div>

        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-key me-2"></i>API Configuration
                </h5>
            </div>
            <div class="card-body p-4">
                <form id="configForm" autocomplete="off">
                    <!-- OpenRouter Configuration -->
                    <div class="mb-4 provider-section cloud">
                        <h6 class="fw-bold text-primary">
                            <i class="fas fa-cloud me-2"></i>OpenRouter API
                            <span class="provider-badge cloud">Cloud API</span>
                            <span class="provider-badge pricing pay-per-use">Pay-Per-Use</span>
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label
                                    for="openrouter_api_key"
                                    class="form-label"
                                    >API Key</label
                                >
                                <input
                                    type="password"
                                    class="form-control"
                                    id="openrouter_api_key"
                                    name="openrouter_api_key"
                                    placeholder="sk-or-..."
                                    autocomplete="new-password"
                                    value="{{ config.openrouter_api_key if config else '' }}"
                                />
                                <div class="form-text">
                                    Get your API key from
                                    <a
                                        href="https://openrouter.ai"
                                        target="_blank"
                                        >OpenRouter</a
                                    >
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button
                                        type="button"
                                        class="btn btn-outline-primary"
                                        onclick="togglePassword('openrouter_api_key')"
                                        aria-label="Toggle OpenRouter API key visibility"
                                        aria-pressed="false"
                                        id="toggle-openrouter_api_key"
                                    >
                                        <i class="fas fa-eye" aria-hidden="true"></i> Show/Hide
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button
                                        type="button"
                                        class="btn btn-outline-success"
                                        onclick="testAPIKey('openrouter')"
                                    >
                                        <i class="fas fa-check"></i> Test Key
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label
                                    for="openrouter_default_model"
                                    class="form-label"
                                    >Default Model</label
                                >
                                <select
                                    class="form-select"
                                    id="openrouter_default_model"
                                    name="openrouter_default_model"
                                >
                                    <option value="">Use System Default</option>
                                    <!-- Models will be loaded dynamically -->
                                </select>
                                <div class="form-text">
                                    Default model to use when "Use Default
                                    Model" is selected for this provider
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button
                                        type="button"
                                        class="btn btn-outline-info"
                                        onclick="loadModelsForProvider('openrouter')"
                                        id="openrouter-refresh-btn"
                                    >
                                        <i class="fas fa-sync me-1"></i>
                                        <span id="openrouter-refresh-text"
                                            >Refresh Models</span
                                        >
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Claude API Configuration -->
                    <div class="mb-4 provider-section cloud">
                        <h6 class="fw-bold text-primary">
                            <i class="fas fa-robot me-2"></i>Claude API (Direct)
                            <span class="provider-badge cloud">Cloud API</span>
                            <span class="provider-badge pricing pay-per-use">Pay-Per-Use</span>
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="claude_api_key" class="form-label"
                                    >API Key</label
                                >
                                <input
                                    type="password"
                                    class="form-control"
                                    id="claude_api_key"
                                    name="claude_api_key"
                                    placeholder="sk-ant-..."
                                    autocomplete="new-password"
                                    value="{{ config.claude_api_key if config else '' }}"
                                />
                                <div class="form-text">
                                    Get your API key from
                                    <a
                                        href="https://console.anthropic.com"
                                        target="_blank"
                                        >Anthropic Console</a
                                    >
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button
                                        type="button"
                                        class="btn btn-outline-primary"
                                        onclick="togglePassword('claude_api_key')"
                                        aria-label="Toggle Claude API key visibility"
                                        aria-pressed="false"
                                        id="toggle-claude_api_key"
                                    >
                                        <i class="fas fa-eye" aria-hidden="true"></i> Show/Hide
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button
                                        type="button"
                                        class="btn btn-outline-success"
                                        onclick="testAPIKey('claude')"
                                    >
                                        <i class="fas fa-check"></i> Test Key
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label
                                    for="claude_default_model"
                                    class="form-label"
                                    >Default Model</label
                                >
                                <select
                                    class="form-select"
                                    id="claude_default_model"
                                    name="claude_default_model"
                                >
                                    <option value="">Use System Default</option>
                                    <!-- Models will be loaded dynamically -->
                                </select>
                                <div class="form-text">
                                    Default model to use when "Use Default
                                    Model" is selected for this provider
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button
                                        type="button"
                                        class="btn btn-outline-info"
                                        onclick="loadModelsForProvider('claude')"
                                        id="claude-refresh-btn"
                                    >
                                        <i class="fas fa-sync me-1"></i>
                                        <span id="claude-refresh-text"
                                            >Refresh Models</span
                                        >
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Google Gemini Configuration -->
                    <div class="mb-4 provider-section cloud">
                        <h6 class="fw-bold text-primary">
                            <i class="fas fa-star me-2"></i>Google Gemini
                            <span class="provider-badge cloud">Cloud API</span>
                            <span class="provider-badge pricing pay-per-use">Pay-Per-Use</span>
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="gemini_api_key" class="form-label"
                                    >API Key</label
                                >
                                <input
                                    type="password"
                                    class="form-control"
                                    id="gemini_api_key"
                                    name="gemini_api_key"
                                    placeholder="your-gemini-key-here"
                                    autocomplete="new-password"
                                    value="{{ config.gemini_api_key if config else '' }}"
                                />
                                <div class="form-text">
                                    Get your API key from
                                    <a
                                        href="https://makersuite.google.com/app/apikey"
                                        target="_blank"
                                        >Google AI Studio</a
                                    >
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button
                                        type="button"
                                        class="btn btn-outline-primary"
                                        onclick="togglePassword('gemini_api_key')"
                                        aria-label="Toggle Gemini API key visibility"
                                        aria-pressed="false"
                                        id="toggle-gemini_api_key"
                                    >
                                        <i class="fas fa-eye" aria-hidden="true"></i> Show/Hide
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button
                                        type="button"
                                        class="btn btn-outline-success"
                                        onclick="testAPIKey('gemini')"
                                    >
                                        <i class="fas fa-check"></i> Test Key
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label
                                    for="gemini_default_model"
                                    class="form-label"
                                    >Default Model</label
                                >
                                <select
                                    class="form-select"
                                    id="gemini_default_model"
                                    name="gemini_default_model"
                                >
                                    <option value="">Use System Default</option>
                                    <!-- Models will be loaded dynamically -->
                                </select>
                                <div class="form-text">
                                    Default model to use when "Use Default
                                    Model" is selected for this provider
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button
                                        type="button"
                                        class="btn btn-outline-info"
                                        onclick="loadModelsForProvider('gemini')"
                                        id="gemini-refresh-btn"
                                    >
                                        <i class="fas fa-sync me-1"></i>
                                        <span id="gemini-refresh-text"
                                            >Refresh Models</span
                                        >
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- OpenAI Configuration -->
                    <div class="mb-4 provider-section cloud">
                        <h6 class="fw-bold text-primary">
                            <i class="fas fa-brain me-2"></i>OpenAI (Direct)
                            <span class="provider-badge cloud">Cloud API</span>
                            <span class="provider-badge pricing pay-per-use">Pay-Per-Use</span>
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="openai_api_key" class="form-label"
                                    >API Key</label
                                >
                                <input
                                    type="password"
                                    class="form-control"
                                    id="openai_api_key"
                                    name="openai_api_key"
                                    placeholder="sk-..."
                                    autocomplete="new-password"
                                    value="{{ config.openai_api_key if config else '' }}"
                                />
                                <div class="form-text">
                                    Get your API key from
                                    <a
                                        href="https://platform.openai.com/api-keys"
                                        target="_blank"
                                        >OpenAI Platform</a
                                    >
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button
                                        type="button"
                                        class="btn btn-outline-primary"
                                        onclick="togglePassword('openai_api_key')"
                                        aria-label="Toggle OpenAI API key visibility"
                                        aria-pressed="false"
                                        id="toggle-openai_api_key"
                                    >
                                        <i class="fas fa-eye" aria-hidden="true"></i> Show/Hide
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button
                                        type="button"
                                        class="btn btn-outline-success"
                                        onclick="testAPIKey('openai')"
                                    >
                                        <i class="fas fa-check"></i> Test Key
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label
                                    for="openai_default_model"
                                    class="form-label"
                                    >Default Model</label
                                >
                                <select
                                    class="form-select"
                                    id="openai_default_model"
                                    name="openai_default_model"
                                >
                                    <option value="">Use System Default</option>
                                    <!-- Models will be loaded dynamically -->
                                </select>
                                <div class="form-text">
                                    Default model to use when "Use Default
                                    Model" is selected for this provider
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button
                                        type="button"
                                        class="btn btn-outline-info"
                                        onclick="loadModelsForProvider('openai')"
                                        id="openai-refresh-btn"
                                    >
                                        <i class="fas fa-sync me-1"></i>
                                        <span id="openai-refresh-text"
                                            >Refresh Models</span
                                        >
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- NanoGPT Configuration -->
                    <div class="mb-4 provider-section cloud">
                        <h6 class="fw-bold text-primary">
                            <i class="fas fa-brain me-2"></i>NanoGPT
                            <span class="provider-badge cloud">Cloud API</span>
                            <span class="provider-badge pricing pay-per-use">Pay-Per-Use</span>
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="nanogpt_api_key" class="form-label"
                                    >API Key</label
                                >
                                <input
                                    type="password"
                                    class="form-control"
                                    id="nanogpt_api_key"
                                    name="nanogpt_api_key"
                                    placeholder="your-nanogpt-key-here"
                                    autocomplete="new-password"
                                    value="{{ config.nanogpt_api_key if config else '' }}"
                                />
                                <div class="form-text">
                                    Get your API key from
                                    <a
                                        href="https://nano-gpt.com"
                                        target="_blank"
                                        >NanoGPT</a
                                    >
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button
                                        type="button"
                                        class="btn btn-outline-primary"
                                        onclick="togglePassword('nanogpt_api_key')"
                                        aria-label="Toggle NanoGPT API key visibility"
                                        aria-pressed="false"
                                        id="toggle-nanogpt_api_key"
                                    >
                                        <i class="fas fa-eye" aria-hidden="true"></i> Show/Hide
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button
                                        type="button"
                                        class="btn btn-outline-success"
                                        onclick="testAPIKey('nanogpt')"
                                    >
                                        <i class="fas fa-check"></i> Test Key
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label
                                    for="nanogpt_default_model"
                                    class="form-label"
                                    >Default Model</label
                                >
                                <select
                                    class="form-select"
                                    id="nanogpt_default_model"
                                    name="nanogpt_default_model"
                                >
                                    <option value="">Use System Default</option>
                                    <!-- Models will be loaded dynamically -->
                                </select>
                                <div class="form-text">
                                    Default model to use when "Use Default
                                    Model" is selected for this provider
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button
                                        type="button"
                                        class="btn btn-outline-info"
                                        onclick="loadModelsForProvider('nanogpt')"
                                        id="nanogpt-refresh-btn"
                                    >
                                        <i class="fas fa-sync me-1"></i>
                                        <span id="nanogpt-refresh-text"
                                            >Refresh Models</span
                                        >
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Chutes AI Configuration -->
                    <div class="mb-4 provider-section cloud">
                        <h6 class="fw-bold text-primary">
                            <i class="fas fa-rocket me-2"></i>Chutes AI
                            <span class="provider-badge cloud">Cloud API</span>
                            <span class="provider-badge pricing pay-per-use">Pay-Per-Use</span>
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="chutes_api_key" class="form-label"
                                    >API Key</label
                                >
                                <input
                                    type="password"
                                    class="form-control"
                                    id="chutes_api_key"
                                    name="chutes_api_key"
                                    placeholder="your-chutes-key-here"
                                    autocomplete="new-password"
                                    value="{{ config.chutes_api_key if config else '' }}"
                                />
                                <div class="form-text">
                                    Get your API key from
                                    <a
                                        href="https://api.chutes.ai"
                                        target="_blank"
                                        >Chutes AI</a
                                    >
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button
                                        type="button"
                                        class="btn btn-outline-primary"
                                        onclick="togglePassword('chutes_api_key')"
                                        aria-label="Toggle Chutes API key visibility"
                                        aria-pressed="false"
                                        id="toggle-chutes_api_key"
                                    >
                                        <i class="fas fa-eye" aria-hidden="true"></i> Show/Hide
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button
                                        type="button"
                                        class="btn btn-outline-success"
                                        onclick="testAPIKey('chutes')"
                                    >
                                        <i class="fas fa-check"></i> Test Key
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label
                                    for="chutes_default_model"
                                    class="form-label"
                                    >Default Model</label
                                >
                                <select
                                    class="form-select"
                                    id="chutes_default_model"
                                    name="chutes_default_model"
                                >
                                    <option value="">Use System Default</option>
                                    <!-- Models will be loaded dynamically -->
                                </select>
                                <div class="form-text">
                                    Default model to use when "Use Default
                                    Model" is selected for this provider
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button
                                        type="button"
                                        class="btn btn-outline-info"
                                        onclick="loadModelsForProvider('chutes')"
                                        id="chutes-refresh-btn"
                                    >
                                        <i class="fas fa-sync me-1"></i>
                                        <span id="chutes-refresh-text"
                                            >Refresh Models</span
                                        >
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Z.AI Configuration -->
                    <div class="mb-4 provider-section cloud">
                        <h6 class="fw-bold text-primary">
                            <i class="fas fa-star me-2"></i>Z.AI
                            <span class="provider-badge cloud">Cloud API</span>
                            <span class="provider-badge pricing pay-per-use" id="zai-pricing-badge-normal">Pay-Per-Use</span>
                            <span class="provider-badge pricing subscription" id="zai-pricing-badge-coding" style="display:none;">Subscription</span>
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="zai_api_key" class="form-label"
                                    >API Key</label
                                >
                                <input
                                    type="password"
                                    class="form-control"
                                    id="zai_api_key"
                                    name="zai_api_key"
                                    placeholder="your-zai-key-here"
                                    autocomplete="new-password"
                                    value="{{ config.zai_api_key if config else '' }}"
                                />
                                <div class="form-text">
                                    Get your API key from
                                    <a href="https://z.ai" target="_blank"
                                        >Z.AI</a
                                    >
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button
                                        type="button"
                                        class="btn btn-outline-primary"
                                        onclick="togglePassword('zai_api_key')"
                                        aria-label="Toggle Z.AI API key visibility"
                                        aria-pressed="false"
                                        id="toggle-zai_api_key"
                                    >
                                        <i class="fas fa-eye" aria-hidden="true"></i> Show/Hide
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button
                                        type="button"
                                        class="btn btn-outline-success"
                                        onclick="testZAIAPIKey()"
                                    >
                                        <i class="fas fa-check"></i> Test Key
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <label class="form-label fw-bold"
                                    >Pricing Plan</label
                                >
                                <div class="form-check form-check-inline">
                                    <input
                                        class="form-check-input"
                                        type="radio"
                                        name="zai_pricing_plan"
                                        id="zai_normal_api"
                                        value="normal"
                                        checked
                                    />
                                    <label
                                        class="form-check-label"
                                        for="zai_normal_api"
                                    >
                                        <i class="fas fa-coins me-1"></i>Normal
                                        API Pricing
                                        <small class="text-muted d-block"
                                            >Pay per use, more models
                                            available</small
                                        >
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input
                                        class="form-check-input"
                                        type="radio"
                                        name="zai_pricing_plan"
                                        id="zai_coding_plan"
                                        value="coding_plan"
                                    />
                                    <label
                                        class="form-check-label"
                                        for="zai_coding_plan"
                                    >
                                        <i class="fas fa-code me-1"></i>Coding
                                        Plan Subscription
                                        <small class="text-muted d-block"
                                            >Monthly subscription, fewer
                                            models</small
                                        >
                                    </label>
                                </div>
                                <div class="form-text">
                                    Choose your Z.AI pricing plan. The Coding
                                    Plan requires an active subscription but
                                    offers unlimited usage for supported models.
                                </div>
                            </div>
                        </div>

                        <!-- Z.AI Pricing Explanation Panel (T052 & T053) -->
                        <div class="row mt-4">
                            <div class="col-md-12">
                                <div class="pricing-plan-explanation">
                                    <h6 class="mb-3">
                                        <i class="fas fa-info-circle me-2"></i>Pricing Plan Comparison
                                    </h6>
                                    <table class="pricing-comparison-table">
                                        <tr>
                                            <td class="feature">Model Availability</td>
                                            <td class="normal-api"><strong>More Models</strong></td>
                                            <td class="coding-plan"><strong>Fewer Models</strong></td>
                                        </tr>
                                        <tr>
                                            <td class="feature">Billing Model</td>
                                            <td class="normal-api"><strong>Pay-Per-Use</strong></td>
                                            <td class="coding-plan"><strong>Monthly Subscription</strong></td>
                                        </tr>
                                        <tr>
                                            <td class="feature">Cost Control</td>
                                            <td class="normal-api">Variable (by usage)</td>
                                            <td class="coding-plan">Fixed monthly fee</td>
                                        </tr>
                                        <tr>
                                            <td class="feature">Best For</td>
                                            <td class="normal-api">Flexible usage</td>
                                            <td class="coding-plan">Heavy users</td>
                                        </tr>
                                    </table>
                                    <p class="mt-3 mb-0 small text-muted">
                                        <i class="fas fa-lightbulb me-1"></i>
                                        Choose <strong>Normal API Pricing</strong> for pay-as-you-go flexibility,
                                        or <strong>Coding Plan Subscription</strong> if you use Z.AI frequently and need predictable costs.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label
                                    for="zai_default_model"
                                    class="form-label"
                                    >Default Model</label
                                >
                                <select
                                    class="form-select"
                                    id="zai_default_model"
                                    name="zai_default_model"
                                >
                                    <option value="">Use System Default</option>
                                    <!-- Models will be loaded dynamically based on pricing plan -->
                                </select>
                                <div class="form-text">
                                    Default model to use when "Use Default
                                    Model" is selected for this provider
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button
                                        type="button"
                                        class="btn btn-outline-info"
                                        onclick="loadModelsForProvider('zai')"
                                        id="zai-refresh-btn"
                                    >
                                        <i class="fas fa-sync me-1"></i>
                                        <span id="zai-refresh-text"
                                            >Refresh Models</span
                                        >
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- LM Studio Configuration -->
                    <div class="mb-4 provider-section local">
                        <h6 class="fw-bold text-primary">
                            <i class="fas fa-server me-2"></i>LM Studio (Local)
                            <span class="provider-badge local">Local Only</span>
                            <span class="provider-badge pricing pay-per-use">Free</span>
                        </h6>
                        <div class="row">
                            <div class="col-md-8">
                                <label for="lm_studio_url" class="form-label"
                                    >API URL</label
                                >
                                <input
                                    type="url"
                                    class="form-control"
                                    id="lm_studio_url"
                                    name="lm_studio_url"
                                    value="{{ config.lm_studio_url if config else 'http://localhost:1234/v1' }}"
                                />
                                <div class="form-text">
                                    Local LM Studio server URL (default:
                                    http://localhost:1234/v1)
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button
                                        type="button"
                                        class="btn btn-outline-secondary"
                                        onclick="testLMStudio()"
                                    >
                                        <i class="fas fa-plug"></i> Test
                                        Connection
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label
                                    for="lm_studio_default_model"
                                    class="form-label"
                                    >Default Model</label
                                >
                                <select
                                    class="form-select"
                                    id="lm_studio_default_model"
                                    name="lm_studio_default_model"
                                >
                                    <option value="">Use System Default</option>
                                    <!-- Models will be loaded dynamically -->
                                </select>
                                <div class="form-text">
                                    Default model to use when "Use Default
                                    Model" is selected for this provider
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button
                                        type="button"
                                        class="btn btn-outline-info"
                                        onclick="loadModelsForProvider('lm_studio')"
                                        id="lm_studio-refresh-btn"
                                    >
                                        <i class="fas fa-sync me-1"></i>
                                        <span id="lm_studio-refresh-text"
                                            >Refresh Models</span
                                        >
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ollama Configuration -->
                    <div class="mb-4 provider-section local">
                        <h6 class="fw-bold text-primary">
                            <i class="fas fa-cube me-2"></i>Ollama (Local)
                            <span class="provider-badge local">Local Only</span>
                            <span class="provider-badge pricing pay-per-use">Free</span>
                        </h6>
                        <div class="row">
                            <div class="col-md-8">
                                <label for="ollama_url" class="form-label"
                                    >API URL</label
                                >
                                <input
                                    type="url"
                                    class="form-control"
                                    id="ollama_url"
                                    name="ollama_url"
                                    value="{{ config.ollama_url if config else 'http://localhost:11434' }}"
                                />
                                <div class="form-text">
                                    Local Ollama server URL (default:
                                    http://localhost:11434)
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button
                                        type="button"
                                        class="btn btn-outline-secondary"
                                        onclick="testOllama()"
                                    >
                                        <i class="fas fa-plug"></i> Test
                                        Connection
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label
                                    for="ollama_default_model"
                                    class="form-label"
                                    >Default Model</label
                                >
                                <select
                                    class="form-select"
                                    id="ollama_default_model"
                                    name="ollama_default_model"
                                >
                                    <option value="">Use System Default</option>
                                    <!-- Models will be loaded dynamically -->
                                </select>
                                <div class="form-text">
                                    Default model to use when "Use Default
                                    Model" is selected for this provider
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button
                                        type="button"
                                        class="btn btn-outline-info"
                                        onclick="loadModelsForProvider('ollama')"
                                        id="ollama-refresh-btn"
                                    >
                                        <i class="fas fa-sync me-1"></i>
                                        <span id="ollama-refresh-text"
                                            >Refresh Models</span
                                        >
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4" />

                    <!-- Default Settings -->
                    <div class="mb-4">
                        <h6 class="fw-bold text-primary">
                            <i class="fas fa-sliders-h me-2"></i>Default
                            Settings
                        </h6>
                        <div class="mb-3">
                            <label for="default_prompt" class="form-label"
                                >Default Grading Prompt</label
                            >
                            <textarea
                                class="form-control"
                                id="default_prompt"
                                name="default_prompt"
                                rows="4"
                                placeholder="Enter your default grading instructions..."
                            >
{{ config.default_prompt if config else 'Please grade this document and provide detailed feedback on:\n1. Content quality and relevance\n2. Structure and organization\n3. Writing style and clarity\n4. Grammar and mechanics\n5. Overall assessment with specific suggestions for improvement\n\nPlease provide a comprehensive evaluation with specific examples from the text.' }}</textarea
                            >
                            <div class="form-text">
                                This prompt will be used as the default when
                                grading documents
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-save me-2"></i>Save Configuration
                        </button>
                        <button
                            type="button"
                            class="btn btn-outline-secondary"
                            onclick="loadFromEnv()"
                        >
                            <i class="fas fa-download me-2"></i>Load from
                            Environment Variables
                        </button>
                    </div>
                </form>

                <!-- Import/Export Configuration Section (T068, T069) -->
                <div class="mt-4 pt-4 border-top">
                    <h6 class="fw-bold text-secondary mb-3">
                        <i class="fas fa-exchange-alt me-2"></i>Bulk Configuration Management
                    </h6>
                    <p class="text-muted small">
                        Export and import your complete configuration settings to quickly replicate across environments.
                    </p>
                    <div class="d-grid gap-2 gap-sm-3">
                        <button
                            type="button"
                            id="export-config-btn"
                            class="btn btn-outline-info"
                        >
                            <i class="fas fa-download me-2"></i>Export Configuration
                        </button>
                        <div class="input-group">
                            <input
                                type="file"
                                id="import-config-file"
                                class="form-control"
                                accept=".json"
                                style="display: none;"
                            />
                            <button
                                type="button"
                                class="btn btn-outline-info"
                                onclick="document.getElementById('import-config-file').click()"
                            >
                                <i class="fas fa-upload me-2"></i>Import Configuration
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Status messages -->
                <div
                    id="statusMessage"
                    class="mt-3"
                    style="display: none"
                ></div>
            </div>
        </div>

        <!-- API Status -->
        <div class="card mt-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="fas fa-heartbeat me-2"></i>API Status
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 col-lg-2 mb-3">
                        <div class="d-flex align-items-center">
                            <div
                                id="openrouter-status"
                                class="status-indicator me-2"
                            ></div>
                            <span>OpenRouter</span>
                            <div
                                id="openrouter-loading"
                                class="spinner-border spinner-border-sm ms-2 d-none"
                                role="status"
                            >
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-lg-2 mb-3">
                        <div class="d-flex align-items-center">
                            <div
                                id="claude-status"
                                class="status-indicator me-2"
                            ></div>
                            <span>Claude API</span>
                            <div
                                id="claude-loading"
                                class="spinner-border spinner-border-sm ms-2 d-none"
                                role="status"
                            >
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-lg-2 mb-3">
                        <div class="d-flex align-items-center">
                            <div
                                id="gemini-status"
                                class="status-indicator me-2"
                            ></div>
                            <span>Gemini</span>
                            <div
                                id="gemini-loading"
                                class="spinner-border spinner-border-sm ms-2 d-none"
                                role="status"
                            >
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-lg-2 mb-3">
                        <div class="d-flex align-items-center">
                            <div
                                id="openai-status"
                                class="status-indicator me-2"
                            ></div>
                            <span>OpenAI</span>
                            <div
                                id="openai-loading"
                                class="spinner-border spinner-border-sm ms-2 d-none"
                                role="status"
                            >
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-lg-2 mb-3">
                        <div class="d-flex align-items-center">
                            <div
                                id="lmstudio-status"
                                class="status-indicator me-2"
                            ></div>
                            <span>LM Studio</span>
                            <div
                                id="lmstudio-loading"
                                class="spinner-border spinner-border-sm ms-2 d-none"
                                role="status"
                            >
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-lg-2 mb-3">
                        <div class="d-flex align-items-center">
                            <div
                                id="ollama-status"
                                class="status-indicator me-2"
                            ></div>
                            <span>Ollama</span>
                            <div
                                id="ollama-loading"
                                class="spinner-border spinner-border-sm ms-2 d-none"
                                role="status"
                            >
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex gap-2 mt-3">
                    <button
                        class="btn btn-sm btn-outline-primary"
                        onclick="checkAllAPIs()"
                    >
                        <i class="fas fa-sync me-1"></i>Check All APIs
                    </button>
                    <button
                        class="btn btn-sm btn-outline-info"
                        onclick="refreshAllModels()"
                    >
                        <i class="fas fa-download me-1"></i>Refresh All Models
                    </button>
                </div>
            </div>
        </div>

        <!-- Help Section -->
        <div class="card mt-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="fas fa-question-circle me-2"></i>Setup Guide
                </h5>
            </div>
            <div class="card-body">
                <div class="accordion" id="helpAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button
                                class="accordion-button"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#openrouter-help"
                            >
                                OpenRouter Setup
                            </button>
                        </h2>
                        <div
                            id="openrouter-help"
                            class="accordion-collapse collapse show"
                            data-bs-parent="#helpAccordion"
                        >
                            <div class="accordion-body">
                                <ol>
                                    <li>
                                        Visit
                                        <a
                                            href="https://openrouter.ai"
                                            target="_blank"
                                            >OpenRouter</a
                                        >
                                    </li>
                                    <li>Sign up for an account</li>
                                    <li>Add payment method</li>
                                    <li>Generate an API key</li>
                                    <li>Copy the key (starts with "sk-or-")</li>
                                    <li>Paste it in the configuration above</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button
                                class="accordion-button collapsed"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#claude-help"
                            >
                                Claude API Setup
                            </button>
                        </h2>
                        <div
                            id="claude-help"
                            class="accordion-collapse collapse"
                            data-bs-parent="#helpAccordion"
                        >
                            <div class="accordion-body">
                                <ol>
                                    <li>
                                        Visit
                                        <a
                                            href="https://console.anthropic.com"
                                            target="_blank"
                                            >Anthropic Console</a
                                        >
                                    </li>
                                    <li>Create an account</li>
                                    <li>Add payment method</li>
                                    <li>Generate an API key</li>
                                    <li>
                                        Copy the key (starts with "sk-ant-")
                                    </li>
                                    <li>Paste it in the configuration above</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button
                                class="accordion-button collapsed"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#gemini-help"
                            >
                                Google Gemini Setup
                            </button>
                        </h2>
                        <div
                            id="gemini-help"
                            class="accordion-collapse collapse"
                            data-bs-parent="#helpAccordion"
                        >
                            <div class="accordion-body">
                                <ol>
                                    <li>
                                        Visit
                                        <a
                                            href="https://makersuite.google.com/app/apikey"
                                            target="_blank"
                                            >Google AI Studio</a
                                        >
                                    </li>
                                    <li>Sign in with your Google account</li>
                                    <li>Click "Create API Key"</li>
                                    <li>Copy the generated API key</li>
                                    <li>Paste it in the configuration above</li>
                                    <li>
                                        Note: Gemini has free tier limits and
                                        paid usage options
                                    </li>
                                </ol>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button
                                class="accordion-button collapsed"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#openai-help"
                            >
                                OpenAI Setup
                            </button>
                        </h2>
                        <div
                            id="openai-help"
                            class="accordion-collapse collapse"
                            data-bs-parent="#helpAccordion"
                        >
                            <div class="accordion-body">
                                <ol>
                                    <li>
                                        Visit
                                        <a
                                            href="https://platform.openai.com/api-keys"
                                            target="_blank"
                                            >OpenAI Platform</a
                                        >
                                    </li>
                                    <li>Sign up or log into your account</li>
                                    <li>
                                        Add payment method (required for API
                                        usage)
                                    </li>
                                    <li>Click "Create new secret key"</li>
                                    <li>Copy the key (starts with "sk-")</li>
                                    <li>Paste it in the configuration above</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button
                                class="accordion-button collapsed"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#lmstudio-help"
                            >
                                LM Studio Setup
                            </button>
                        </h2>
                        <div
                            id="lmstudio-help"
                            class="accordion-collapse collapse"
                            data-bs-parent="#helpAccordion"
                        >
                            <div class="accordion-body">
                                <ol>
                                    <li>
                                        Download
                                        <a
                                            href="https://lmstudio.ai"
                                            target="_blank"
                                            >LM Studio</a
                                        >
                                    </li>
                                    <li>Install and launch the application</li>
                                    <li>
                                        Download a model (e.g., Llama 2,
                                        Mistral)
                                    </li>
                                    <li>Start the local server</li>
                                    <li>
                                        Ensure the API URL is correct (default:
                                        http://localhost:1234/v1)
                                    </li>
                                    <li>
                                        Test the connection using the button
                                        above
                                    </li>
                                </ol>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button
                                class="accordion-button collapsed"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#ollama-help"
                            >
                                Ollama Setup
                            </button>
                        </h2>
                        <div
                            id="ollama-help"
                            class="accordion-collapse collapse"
                            data-bs-parent="#helpAccordion"
                        >
                            <div class="accordion-body">
                                <ol>
                                    <li>
                                        Download
                                        <a
                                            href="https://ollama.ai"
                                            target="_blank"
                                            >Ollama</a
                                        >
                                    </li>
                                    <li>Install and start Ollama service</li>
                                    <li>
                                        Download a model:
                                        <code>ollama pull llama2</code> or
                                        <code>ollama pull mistral</code>
                                    </li>
                                    <li>
                                        Ensure Ollama is running (default:
                                        http://localhost:11434)
                                    </li>
                                    <li>
                                        Verify the API URL is correct (default:
                                        http://localhost:11434)
                                    </li>
                                    <li>
                                        Test the connection using the button
                                        above
                                    </li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block scripts %}

<style>
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: #6c757d;
    }
    .status-indicator.online {
        background-color: #28a745;
    }
    .status-indicator.offline {
        background-color: #dc3545;
    }

    /* Accessibility: Focus indicators for keyboard navigation (US6) */
    button:focus,
    button:focus-visible {
        outline: 2px solid #667eea;
        outline-offset: 2px;
    }

    .btn:focus,
    .btn:focus-visible {
        box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.5);
    }

    input:focus,
    select:focus,
    textarea:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    /* Ensure focus outline is always visible */
    *:focus-visible {
        outline: 2px solid #667eea;
        outline-offset: 2px;
    }

    /* Provider type badges (User Story 3) */
    .provider-badge {
        display: inline-block;
        padding: 0.35rem 0.65rem;
        font-size: 0.75rem;
        font-weight: 600;
        border-radius: 0.25rem;
        margin-left: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .provider-badge.cloud {
        background-color: #cfe2ff;
        color: #084298;
        border: 1px solid #b6d4fe;
    }

    .provider-badge.local {
        background-color: #f8d7da;
        color: #842029;
        border: 1px solid #f5c2c7;
    }

    .provider-badge.pricing {
        display: inline-block;
        font-size: 0.70rem;
        font-weight: 500;
        margin-left: 0.25rem;
        padding: 0.25rem 0.45rem;
    }

    .provider-badge.pricing.pay-per-use {
        background-color: #e7f3ff;
        color: #0056b3;
    }

    .provider-badge.pricing.subscription {
        background-color: #fff3cd;
        color: #856404;
    }

    .provider-section {
        border-left: 4px solid #e9ecef;
        padding-left: 1rem;
        margin-bottom: 2rem;
    }

    .provider-section.cloud {
        border-left-color: #0d6efd;
    }

    .provider-section.local {
        border-left-color: #dc3545;
    }

    .pricing-plan-explanation {
        background-color: #f8f9fa;
        border-left: 4px solid #0d6efd;
        padding: 1rem;
        margin-top: 1rem;
        border-radius: 0.25rem;
    }

    .pricing-plan-explanation.warning {
        background-color: #fffbea;
        border-left-color: #ffc107;
    }

    .pricing-comparison-table {
        width: 100%;
        margin-top: 0.5rem;
        font-size: 0.9rem;
    }

    .pricing-comparison-table tr {
        border-bottom: 1px solid #dee2e6;
    }

    .pricing-comparison-table td {
        padding: 0.5rem;
    }

    .pricing-comparison-table .feature {
        font-weight: 500;
        width: 40%;
    }

    .pricing-comparison-table .normal-api {
        text-align: center;
        color: #0056b3;
    }

    .pricing-comparison-table .coding-plan {
        text-align: center;
        color: #856404;
    }
</style>

<script>
    function togglePassword(fieldId) {
        const field = document.getElementById(fieldId);
        const button = event.target.closest("button");
        const icon = button.querySelector("i");

        if (field.type === "password") {
            field.type = "text";
            icon.className = "fas fa-eye-slash";
            button.setAttribute("aria-pressed", "true");
        } else {
            field.type = "password";
            icon.className = "fas fa-eye";
            button.setAttribute("aria-pressed", "false");
        }
    }

    function setDefaultModelValue(provider, value) {
        const select = document.getElementById(`${provider}_default_model`);
        if (select) {
            select.value = value || "";
        }
    }

    function showStatus(message, type = "success") {
        const statusDiv = document.getElementById("statusMessage");
        statusDiv.className = `alert alert-${type}`;
        statusDiv.innerHTML = message;
        statusDiv.style.display = "block";

        setTimeout(() => {
            statusDiv.style.display = "none";
        }, 5000);
    }

    function testLMStudio() {
        const url = document.getElementById("lm_studio_url").value;
        const statusIndicator = document.getElementById("lmstudio-status");

        statusIndicator.className = "status-indicator";

        fetch("/test_lm_studio", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ url: url }),
        })
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    statusIndicator.classList.add("online");
                    showStatus("LM Studio connection successful!", "success");
                } else {
                    statusIndicator.classList.add("offline");
                    showStatus(
                        "LM Studio connection failed: " + data.error,
                        "danger",
                    );
                }
            })
            .catch((error) => {
                statusIndicator.classList.add("offline");
                showStatus(
                    "Connection test failed: " + error.message,
                    "danger",
                );
            });
    }

    function loadFromEnv() {
        // Load values from environment variables via API
        fetch("/load_config")
            .then((response) => response.json())
            .then((data) => {
                document.getElementById("openrouter_api_key").value =
                    data.openrouter_api_key || "";
                document.getElementById("claude_api_key").value =
                    data.claude_api_key || "";
                document.getElementById("gemini_api_key").value =
                    data.gemini_api_key || "";
                document.getElementById("openai_api_key").value =
                    data.openai_api_key || "";
                document.getElementById("nanogpt_api_key").value =
                    data.nanogpt_api_key || "";
                document.getElementById("chutes_api_key").value =
                    data.chutes_api_key || "";
                document.getElementById("zai_api_key").value =
                    data.zai_api_key || "";
                document.getElementById("lm_studio_url").value =
                    data.lm_studio_url || "http://localhost:1234/v1";
                document.getElementById("ollama_url").value =
                    data.ollama_url || "http://localhost:11434";

                // Set Z.AI pricing plan
                if (data.zai_pricing_plan) {
                    const pricingRadio = document.querySelector(
                        `input[name="zai_pricing_plan"][value="${data.zai_pricing_plan}"]`,
                    );
                    if (pricingRadio) {
                        pricingRadio.checked = true;
                    }
                }
                document.getElementById("default_prompt").value =
                    data.default_prompt || "";

                // Load default model configurations
                setDefaultModelValue(
                    "openrouter",
                    data.openrouter_default_model,
                );
                setDefaultModelValue("claude", data.claude_default_model);
                setDefaultModelValue("gemini", data.gemini_default_model);
                setDefaultModelValue("openai", data.openai_default_model);
                setDefaultModelValue("lm_studio", data.lm_studio_default_model);
                setDefaultModelValue("ollama", data.ollama_default_model);
                setDefaultModelValue("nanogpt", data.nanogpt_default_model);
                setDefaultModelValue("chutes", data.chutes_default_model);
                setDefaultModelValue("zai", data.zai_default_model);

                showStatus("Configuration loaded successfully", "success");
            })
            .catch((error) => {
                showStatus(
                    "Failed to load configuration: " + error.message,
                    "danger",
                );
            });
    }

    function testOllama() {
        const url = document.getElementById("ollama_url").value;
        const statusIndicator = document.getElementById("ollama-status");

        statusIndicator.className = "status-indicator";

        fetch("/test_ollama", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ url: url }),
        })
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    statusIndicator.classList.add("online");
                    showStatus("Ollama connection successful!", "success");
                } else {
                    statusIndicator.classList.add("offline");
                    showStatus(
                        "Ollama connection failed: " + data.error,
                        "danger",
                    );
                }
            })
            .catch((error) => {
                statusIndicator.classList.add("offline");
                showStatus(
                    "Connection test failed: " + error.message,
                    "danger",
                );
            });
    }

    function checkAllAPIs() {
        const statusIndicators = {
            "openrouter-status": document.getElementById("openrouter-status"),
            "claude-status": document.getElementById("claude-status"),
            "gemini-status": document.getElementById("gemini-status"),
            "openai-status": document.getElementById("openai-status"),
            "lmstudio-status": document.getElementById("lmstudio-status"),
            "ollama-status": document.getElementById("ollama-status"),
        };

        // Reset all status indicators
        Object.values(statusIndicators).forEach((indicator) => {
            indicator.className = "status-indicator";
        });

        // Test OpenRouter
        const openrouterKey =
            document.getElementById("openrouter_api_key").value;
        if (openrouterKey) {
            statusIndicators["openrouter-status"].classList.add("online");
        } else {
            statusIndicators["openrouter-status"].classList.add("offline");
        }

        // Test Claude API
        const claudeKey = document.getElementById("claude_api_key").value;
        if (claudeKey) {
            statusIndicators["claude-status"].classList.add("online");
        } else {
            statusIndicators["claude-status"].classList.add("offline");
        }

        // Test Gemini API
        const geminiKey = document.getElementById("gemini_api_key").value;
        if (geminiKey) {
            statusIndicators["gemini-status"].classList.add("online");
        } else {
            statusIndicators["gemini-status"].classList.add("offline");
        }

        // Test OpenAI API
        const openaiKey = document.getElementById("openai_api_key").value;
        if (openaiKey) {
            statusIndicators["openai-status"].classList.add("online");
        } else {
            statusIndicators["openai-status"].classList.add("offline");
        }

        // Test LM Studio
        testLMStudio();

        // Test Ollama
        testOllama();

        showStatus("API status check completed", "info");
    }

    function testAPIKey(provider) {
        const apiKeyField = document.getElementById(`${provider}_api_key`);
        const statusIndicator = document.getElementById(`${provider}-status`);
        const apiKey = apiKeyField.value;

        statusIndicator.className = "status-indicator";

        if (!apiKey) {
            statusIndicator.classList.add("offline");
            showStatus(
                `${provider.charAt(0).toUpperCase() + provider.slice(1)} API key not set.`,
                "warning",
            );
            return;
        }

        // Show loading state
        statusIndicator.className = "status-indicator";
        showStatus(
            `Testing ${provider.charAt(0).toUpperCase() + provider.slice(1)} API key...`,
            "info",
        );

        fetch("/test_api_key", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                type: provider,
                key: apiKey,
            }),
        })
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    statusIndicator.classList.add("online");
                    showStatus(data.message, "success");
                } else {
                    statusIndicator.classList.add("offline");
                    showStatus(data.error, "danger");
                }
            })
            .catch((error) => {
                statusIndicator.classList.add("offline");
                showStatus(
                    `${provider.charAt(0).toUpperCase() + provider.slice(1)} API key test failed: ${error.message}`,
                    "danger",
                );
            });
    }

    // Dynamic model loading functions
    function loadModelsForProvider(provider) {
        const select = document.getElementById(`${provider}_default_model`);
        const statusIndicator = document.getElementById(`${provider}-status`);
        const loadingIndicator = document.getElementById(`${provider}-loading`);
        const refreshButton = document.getElementById(
            `${provider}-refresh-btn`,
        );
        const refreshText = document.getElementById(`${provider}-refresh-text`);

        // Show loading state
        select.innerHTML = '<option value="">Loading models...</option>';
        select.disabled = true;

        // Show loading spinner
        if (loadingIndicator) {
            loadingIndicator.classList.remove("d-none");
        }

        // Update refresh button
        if (refreshButton) {
            refreshButton.disabled = true;
        }
        if (refreshText) {
            refreshText.textContent = "Refreshing...";
        }

        fetch(`/api/models/${provider}`)
            .then((response) => response.json())
            .then((data) => {
                // Clear existing options
                select.innerHTML = "";

                // Handle the actual API response format: {popular: [], default: ""}
                if (data && data.popular && Array.isArray(data.popular)) {
                    // Add default option
                    const defaultOption = document.createElement("option");
                    defaultOption.value = "";
                    defaultOption.textContent = "Use System Default";
                    select.appendChild(defaultOption);

                    // Add models from popular array
                    data.popular.forEach((modelId) => {
                        const option = document.createElement("option");
                        option.value = modelId;
                        option.textContent = modelId;
                        select.appendChild(option);
                    });

                    // Set the default model if it exists
                    if (data.default) {
                        select.value = data.default;
                    }

                    select.disabled = false;
                    if (statusIndicator) {
                        statusIndicator.classList.remove("offline");
                        statusIndicator.classList.add("online");
                    }
                } else if (data.error) {
                    // Handle error case
                    const errorOption = document.createElement("option");
                    errorOption.value = "";
                    errorOption.textContent = "Error loading models";
                    select.appendChild(errorOption);
                    select.disabled = true;
                    if (statusIndicator) {
                        statusIndicator.classList.remove("online");
                        statusIndicator.classList.add("offline");
                    }
                    showStatus(
                        `Failed to load models for ${provider}: ${data.error}`,
                        "danger",
                    );
                } else {
                    // Handle unexpected response format
                    const errorOption = document.createElement("option");
                    errorOption.value = "";
                    errorOption.textContent = "Invalid response format";
                    select.appendChild(errorOption);
                    select.disabled = true;
                    if (statusIndicator) {
                        statusIndicator.classList.remove("online");
                        statusIndicator.classList.add("offline");
                    }
                    showStatus(
                        `Failed to load models for ${provider}: Invalid response format`,
                        "danger",
                    );
                }
            })
            .catch((error) => {
                select.innerHTML =
                    '<option value="">Failed to load models</option>';
                select.disabled = true;
                if (statusIndicator) {
                    statusIndicator.classList.remove("online");
                    statusIndicator.classList.add("offline");
                }
                showStatus(
                    `Network error loading models for ${provider}: ${error.message}`,
                    "danger",
                );
            })
            .finally(() => {
                // Hide loading spinner
                if (loadingIndicator) {
                    loadingIndicator.classList.add("d-none");
                }

                // Restore refresh button
                if (refreshButton) {
                    refreshButton.disabled = false;
                }
                if (refreshText) {
                    refreshText.textContent = "Refresh Models";
                }
            });
    }

    function refreshAllModels() {
        const providers = [
            "openrouter",
            "claude",
            "gemini",
            "openai",
            "lm_studio",
            "ollama",
        ];

        showStatus("Refreshing all model lists...", "info");

        // Create a promise for each provider
        const promises = providers.map((provider) => {
            return new Promise((resolve) => {
                loadModelsForProvider(provider);
                // Small delay to allow UI updates
                setTimeout(resolve, 100);
            });
        });

        // Wait for all providers to finish loading
        Promise.all(promises)
            .then(() => {
                showStatus(
                    "All model lists refreshed successfully!",
                    "success",
                );
            })
            .catch((error) => {
                showStatus("Some model lists failed to refresh", "warning");
            });
    }

    // Initialize dynamic model loading on page load
    document.addEventListener("DOMContentLoaded", function () {
        // Load models for all providers
        refreshAllModels();
    });

    $(document).ready(function () {
        // Load current configuration on page load
        loadFromEnv();

        $("#configForm").on("submit", function (e) {
            e.preventDefault();

            const formData = new FormData(this);

            // Show loading state
            const submitBtn = $(this).find('button[type="submit"]');
            const originalText = submitBtn.html();
            submitBtn.html(
                '<i class="fas fa-spinner fa-spin me-2"></i>Saving...',
            );
            submitBtn.prop("disabled", true);

            $.ajax({
                url: "/save_config",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    if (response.success) {
                        showStatus(
                            "Configuration saved successfully!",
                            "success",
                        );
                    } else {
                        showStatus(
                            "Failed to save configuration: " + response.message,
                            "danger",
                        );
                    }
                },
                error: function (xhr) {
                    let errorMessage =
                        "An error occurred while saving configuration";
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    showStatus(errorMessage, "danger");
                },
                complete: function () {
                    // Restore button state
                    submitBtn.html(originalText);
                    submitBtn.prop("disabled", false);
                },
            });
        });
    });

    // Handle Z.AI pricing plan changes
    function handleZAiPricingPlanChange() {
        const pricingPlan = document.querySelector(
            'input[name="zai_pricing_plan"]:checked',
        ).value;
        const modelSelect = document.getElementById("zai_default_model");
        const refreshBtn = document.getElementById("zai-refresh-btn");

        // Update pricing badges (T053)
        const normalBadge = document.getElementById("zai-pricing-badge-normal");
        const codingBadge = document.getElementById("zai-pricing-badge-coding");
        if (normalBadge && codingBadge) {
            if (pricingPlan === "coding_plan") {
                normalBadge.style.display = "none";
                codingBadge.style.display = "inline-block";
            } else {
                normalBadge.style.display = "inline-block";
                codingBadge.style.display = "none";
            }
        }

        // Clear current models
        modelSelect.innerHTML = '<option value="">Loading models...</option>';
        modelSelect.disabled = true;

        // Update button text based on pricing plan
        const refreshText = document.getElementById("zai-refresh-text");
        if (refreshText) {
            refreshText.textContent =
                pricingPlan === "coding_plan"
                    ? "Refresh Coding Plan Models"
                    : "Refresh Normal API Models";
        }

        // Update the form-text description
        const formText = modelSelect.parentElement.nextElementSibling;
        if (formText && formText.classList.contains("form-text")) {
            formText.innerHTML = `Default model to use when "Use Default Model" is selected for this provider
                (${pricingPlan === "coding_plan" ? "Coding Plan subscription" : "Normal API pricing"})`;
        }

        // Load models based on pricing plan
        const providerKey =
            pricingPlan === "coding_plan" ? "zai_coding_plan" : "zai";
        loadModelsForProvider(providerKey);
    }

    // Add event listener for Z.AI pricing plan changes
    document.addEventListener("DOMContentLoaded", function () {
        const zaiRadios = document.querySelectorAll(
            'input[name="zai_pricing_plan"]',
        );
        zaiRadios.forEach((radio) => {
            radio.addEventListener("change", handleZAiPricingPlanChange);
        });

        // Load initial models based on current selection
        const currentPlan =
            document.querySelector('input[name="zai_pricing_plan"]:checked')
                ?.value || "normal";
        if (currentPlan) {
            handleZAiPricingPlanChange();
        }
    });

    // Test Z.AI API key considering pricing plan
    function testZAIAPIKey() {
        const apiKeyField = document.getElementById("zai_api_key");
        const statusIndicator = document.getElementById("zai-status");
        const pricingPlan = document.querySelector(
            'input[name="zai_pricing_plan"]:checked',
        ).value;
        const apiKey = apiKeyField.value;

        statusIndicator.className = "status-indicator";

        if (!apiKey) {
            statusIndicator.classList.add("offline");
            showStatus(
                `Z.AI API key not set (${pricingPlan === "coding_plan" ? "Coding Plan" : "Normal API"}).`,
                "warning",
            );
            return;
        }

        // Show loading state
        statusIndicator.className = "status-indicator";
        showStatus(
            `Testing Z.AI API key (${pricingPlan === "coding_plan" ? "Coding Plan" : "Normal API"})...`,
            "info",
        );

        const apiType =
            pricingPlan === "coding_plan" ? "zai_coding_plan" : "zai";

        fetch("/test_api_key", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                type: apiType,
                key: apiKey,
            }),
        })
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    statusIndicator.classList.add("online");
                    showStatus(data.message, "success");
                } else {
                    statusIndicator.classList.add("offline");
                    showStatus(data.error, "danger");
                }
            })
            .catch((error) => {
                statusIndicator.classList.add("offline");
                showStatus(
                    `Z.AI API key test failed: ${error.message}`,
                    "danger",
                );
            });
    }
</script>

<!-- Include bulk configuration management script (T065, T066, T070) -->
<script src="{{ url_for('static', filename='js/config.js') }}"></script>

{% endblock %}
