{% extends "base.html" %}

{% block title %}Image Submissions - {{ submission.student_name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="display-4 fw-bold text-primary mb-2">
                    <i class="fas fa-images me-3"></i>
                    Image Submissions
                </h1>
                <p class="lead text-muted">Student: {{ submission.student_name }}</p>
            </div>
            <div class="text-end">
                <a href="/jobs/{{ submission.job_id }}" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Job
                </a>
                <button class="btn btn-primary" onclick="location.reload()">
                    <i class="fas fa-sync me-2"></i>Refresh
                </button>
            </div>
        </div>

        <!-- Image Upload Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cloud-upload-alt me-2"></i>Upload New Image
                </h5>
            </div>
            <div class="card-body">
                <form id="imageUploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="imageFile" class="form-label">Select Image (PNG, JPG, JPEG, GIF, WebP, BMP - Max 50MB)</label>
                        <input type="file" class="form-control" id="imageFile" name="image" accept="image/*" required>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload me-2"></i>Upload Image
                    </button>
                </form>
                <div id="uploadStatus" class="mt-3"></div>
            </div>
        </div>

        <!-- Existing Images -->
        <div class="row" id="imagesContainer">
            {% if images %}
                {% for image in images %}
                <div class="col-md-6 mb-4" id="image-{{ image.id }}">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-image me-2"></i>{{ image.original_filename }}
                            </h6>
                            <span class="badge bg-{{ 'success' if image.processing_status == 'completed' else 'warning' if image.processing_status == 'processing' else 'info' if image.processing_status == 'queued' else 'danger' }}">
                                {{ image.processing_status.title() }}
                            </span>
                        </div>
                        <div class="card-body">
                            <!-- Image Thumbnail -->
                            <div class="text-center mb-3">
                                <img src="/api/images/{{ image.id }}/download"
                                     alt="{{ image.original_filename }}"
                                     class="img-fluid rounded shadow-sm"
                                     style="max-height: 300px; cursor: pointer;"
                                     onclick="viewFullImage({{ image.id }}, '{{ image.original_filename }}')">
                            </div>

                            <!-- File Info -->
                            <div class="small text-muted mb-3">
                                <div><strong>Size:</strong> {{ (image.file_size_bytes / 1024 / 1024) | round(2) }} MB</div>
                                <div><strong>Uploaded:</strong> {{ image.uploaded_at.strftime('%Y-%m-%d %H:%M:%S') }}</div>
                                <div><strong>Format:</strong> {{ image.mime_type }}</div>
                            </div>

                            <!-- OCR Results (if completed) -->
                            {% if image.processing_status == 'completed' and image.extracted_content %}
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong>OCR Results:</strong>
                                    <span class="badge bg-success">
                                        Confidence: {{ (image.extracted_content.confidence_score * 100) | round(1) }}%
                                    </span>
                                </div>
                                <div class="collapse" id="ocr-text-{{ image.id }}">
                                    <div class="border rounded p-3 bg-light" style="max-height: 200px; overflow-y: auto;">
                                        <pre class="mb-0" style="white-space: pre-wrap; font-size: 0.85rem;">{{ image.extracted_content.extracted_text }}</pre>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-outline-primary w-100"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#ocr-text-{{ image.id }}">
                                    <i class="fas fa-eye me-2"></i>Toggle Extracted Text
                                </button>
                            </div>
                            {% elif image.processing_status == 'processing' or image.processing_status == 'queued' %}
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                OCR processing in progress...
                            </div>
                            {% elif image.processing_status == 'failed' %}
                            <div class="alert alert-danger mb-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                OCR processing failed
                            </div>
                            {% endif %}

                            <!-- Actions -->
                            <div class="d-flex gap-2">
                                <a href="/api/images/{{ image.id }}/download"
                                   class="btn btn-sm btn-outline-primary flex-fill"
                                   download="{{ image.original_filename }}">
                                    <i class="fas fa-download me-1"></i>Download
                                </a>
                                <button class="btn btn-sm btn-outline-danger flex-fill"
                                        onclick="deleteImage({{ image.id }}, '{{ image.original_filename }}')">
                                    <i class="fas fa-trash me-1"></i>Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        No images uploaded yet. Use the form above to upload your first image.
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Full Image Modal -->
<div class="modal fade" id="fullImageModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fullImageModalLabel">Image Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="fullImagePreview" src="" alt="" class="img-fluid">
            </div>
        </div>
    </div>
</div>

<script>
    // Upload image
    document.getElementById('imageUploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData();
        const fileInput = document.getElementById('imageFile');
        formData.append('image', fileInput.files[0]);

        const statusDiv = document.getElementById('uploadStatus');
        statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Uploading...</div>';

        try {
            const response = await fetch('/api/submissions/{{ submission.id }}/images', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                statusDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check me-2"></i>Image uploaded successfully! Refreshing...</div>';
                setTimeout(() => location.reload(), 1500);
            } else {
                statusDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>${data.error}</div>`;
            }
        } catch (error) {
            statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Upload failed. Please try again.</div>';
        }
    });

    // View full image
    function viewFullImage(imageId, filename) {
        document.getElementById('fullImageModalLabel').textContent = filename;
        document.getElementById('fullImagePreview').src = `/api/images/${imageId}/download`;
        new bootstrap.Modal(document.getElementById('fullImageModal')).show();
    }

    // Delete image
    async function deleteImage(imageId, filename) {
        if (!confirm(`Are you sure you want to delete "${filename}"?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/images/${imageId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                document.getElementById(`image-${imageId}`).remove();

                // Show message if no images left
                const container = document.getElementById('imagesContainer');
                if (container.children.length === 0) {
                    container.innerHTML = '<div class="col-12"><div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No images uploaded yet.</div></div>';
                }
            } else {
                alert('Failed to delete image. Please try again.');
            }
        } catch (error) {
            alert('Failed to delete image. Please try again.');
        }
    }

    // Auto-refresh for processing images
    const hasProcessingImages = {{ 'true' if images and any(img.processing_status in ['queued', 'processing'] for img in images) else 'false' }};
    if (hasProcessingImages) {
        setTimeout(() => location.reload(), 5000); // Refresh every 5 seconds
    }
</script>
{% endblock %}
