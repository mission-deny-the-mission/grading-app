openapi: 3.0.0
info:
  title: Marking Schemes API
  version: '1.0.0'
  description: |
    API for saving, loading, sharing, and converting marking schemes.
    Supports export/import in JSON format and document-based rubric conversion.

    **Authentication**: All endpoints require valid user session (Flask-Login)
    **Versioning**: URL-based (future: /v2/schemes/...)
    **Error Codes**: Standard HTTP + custom codes in response body

servers:
  - url: http://localhost:5000
    description: Development
  - url: https://grading-app.example.com
    description: Production (web)

paths:
  /schemes/{scheme_id}/export:
    post:
      summary: Export marking scheme to JSON file
      operationId: exportMarkingScheme
      tags:
        - Marking Schemes - Save/Load
      parameters:
        - name: scheme_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Marking scheme ID to export
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                file_name:
                  type: string
                  maxLength: 500
                  description: Optional custom file name (default: scheme_name.json)
                include_metadata:
                  type: boolean
                  default: true
                  description: Include metadata (name, description, export date)
      responses:
        '200':
          description: Scheme exported successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  file_url:
                    type: string
                    description: URL to download exported JSON file
                  file_name:
                    type: string
                  export_date:
                    type: string
                    format: date-time
                  version:
                    type: string
                    description: Export format version
        '403':
          description: Insufficient permissions
        '404':
          description: Marking scheme not found
        '500':
          description: Export failed (validation, I/O error)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /schemes/{scheme_id}/download:
    get:
      summary: Download exported marking scheme file
      operationId: downloadMarkingScheme
      tags:
        - Marking Schemes - Save/Load
      parameters:
        - name: scheme_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: File download
          content:
            application/json:
              schema:
                type: object
                description: MarkingScheme JSON export
        '404':
          description: Scheme or export not found

  /schemes/import:
    post:
      summary: Import marking scheme from JSON file
      operationId: importMarkingScheme
      tags:
        - Marking Schemes - Save/Load
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: JSON file containing marking scheme
                create_if_exists:
                  type: boolean
                  default: true
                  description: Create new scheme if imported name already exists
      responses:
        '201':
          description: Scheme imported successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  scheme_id:
                    type: string
                    format: uuid
                  name:
                    type: string
                  criteria_count:
                    type: integer
                  created_at:
                    type: string
                    format: date-time
        '400':
          description: Invalid file format or schema validation error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error_code:
                    type: string
                    enum:
                      - INVALID_JSON
                      - SCHEMA_VALIDATION_ERROR
                      - MISSING_REQUIRED_FIELD
                      - INVALID_CRITERIA
                  message:
                    type: string
                  details:
                    type: array
                    items:
                      type: string
                    description: Validation errors
        '413':
          description: File too large (>50MB)
        '500':
          description: Import processing failed

  /schemes/{scheme_id}/documents/upload:
    post:
      summary: Upload document-based rubric for conversion
      operationId: uploadDocumentRubric
      tags:
        - Marking Schemes - Document Conversion
      parameters:
        - name: scheme_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Scheme ID to associate with conversion
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                document:
                  type: string
                  format: binary
                  description: Rubric document (PDF, DOCX, PNG, JPG)
                document_type:
                  type: string
                  enum:
                    - application/pdf
                    - application/vnd.openxmlformats-officedocument.wordprocessingml.document
                    - image/png
                    - image/jpeg
                  description: Document MIME type (detected if not provided)
      responses:
        '202':
          description: Document queued for processing
          content:
            application/json:
              schema:
                type: object
                properties:
                  conversion_id:
                    type: string
                    format: uuid
                    description: ID for polling conversion status
                  status:
                    type: string
                    enum:
                      - PENDING
                      - QUEUED
                    description: Current processing status
                  estimated_seconds:
                    type: integer
                    description: Estimated time to completion
        '400':
          description: Invalid document format or unsupported type
        '413':
          description: Document too large (>50MB)
        '500':
          description: Upload failed

  /schemes/{scheme_id}/documents/{conversion_id}/status:
    get:
      summary: Poll document conversion status
      operationId: getConversionStatus
      tags:
        - Marking Schemes - Document Conversion
      parameters:
        - name: scheme_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: conversion_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Conversion status
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum:
                      - PENDING
                      - QUEUED
                      - PROCESSING
                      - SUCCESS
                      - FAILED
                  progress:
                    type: number
                    minimum: 0
                    maximum: 100
                    description: Percentage complete (0-100)
                  result:
                    $ref: '#/components/schemas/ConversionResult'
                  error:
                    $ref: '#/components/schemas/ConversionError'
        '404':
          description: Conversion not found

  /schemes/{scheme_id}/documents/{conversion_id}/result:
    get:
      summary: Get conversion result (after completion)
      operationId: getConversionResult
      tags:
        - Marking Schemes - Document Conversion
      parameters:
        - name: scheme_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: conversion_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Conversion result
          content:
            application/json:
              schema:
                type: object
                properties:
                  extracted_scheme:
                    type: object
                    description: Extracted MarkingScheme (JSON matching export format)
                  uncertainty_flags:
                    type: array
                    items:
                      type: object
                      properties:
                        field:
                          type: string
                        confidence:
                          type: number
                          minimum: 0
                          maximum: 1
                        reason:
                          type: string
                  llm_provider:
                    type: string
                  conversion_time_ms:
                    type: integer
        '202':
          description: Conversion still in progress
        '400':
          description: Conversion failed or not found
        '404':
          description: Conversion result not found

  /schemes/{scheme_id}/documents/{conversion_id}/accept:
    post:
      summary: Accept converted scheme (save after review)
      operationId: acceptConversion
      tags:
        - Marking Schemes - Document Conversion
      parameters:
        - name: scheme_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: conversion_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                extracted_scheme:
                  type: object
                  description: Optionally modified scheme after user review
                save_name:
                  type: string
                  maxLength: 200
                  description: Name for saved scheme
      responses:
        '201':
          description: Scheme accepted and saved
          content:
            application/json:
              schema:
                type: object
                properties:
                  scheme_id:
                    type: string
                    format: uuid
                  name:
                    type: string
                  created_at:
                    type: string
                    format: date-time
        '400':
          description: Conversion not found or already accepted
        '422':
          description: Provided scheme invalid

  /schemes/{scheme_id}/share:
    post:
      summary: Share marking scheme with users or groups
      operationId: shareScheme
      tags:
        - Marking Schemes - Sharing (Web Only)
      parameters:
        - name: scheme_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - recipients
                - permission
              properties:
                recipients:
                  type: array
                  minItems: 1
                  maxItems: 50
                  items:
                    oneOf:
                      - type: object
                        required:
                          - type
                          - user_id
                        properties:
                          type:
                            const: user
                          user_id:
                            type: string
                            format: uuid
                      - type: object
                        required:
                          - type
                          - group_id
                        properties:
                          type:
                            const: group
                          group_id:
                            type: string
                            format: uuid
                permission:
                  type: string
                  enum:
                    - VIEW_ONLY
                    - EDITABLE
                    - COPY
                  description: Permission level for all recipients
                notify:
                  type: boolean
                  default: true
                  description: Send notification to recipients
      responses:
        '200':
          description: Sharing configured successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  shares_created:
                    type: integer
                    description: Number of share relationships created
                  shared_with:
                    type: array
                    items:
                      type: object
                      properties:
                        user_id:
                          type: string
                        group_id:
                          type: string
                        permission:
                          type: string
                        shared_at:
                          type: string
                          format: date-time
        '403':
          description: Not scheme owner; insufficient permissions
        '404':
          description: Scheme or recipient not found
        '422':
          description: Invalid recipients or permission

  /schemes/{scheme_id}/share/{share_id}/revoke:
    delete:
      summary: Revoke access to shared scheme
      operationId: revokeSchemeAccess
      tags:
        - Marking Schemes - Sharing (Web Only)
      parameters:
        - name: scheme_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: share_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Access revoked successfully
        '403':
          description: Not scheme owner; insufficient permissions
        '404':
          description: Share relationship not found

  /schemes/{scheme_id}/shares:
    get:
      summary: List all shares for a scheme (owner only)
      operationId: listShares
      tags:
        - Marking Schemes - Sharing (Web Only)
      parameters:
        - name: scheme_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of shares
          content:
            application/json:
              schema:
                type: object
                properties:
                  scheme_id:
                    type: string
                  shares:
                    type: array
                    items:
                      type: object
                      properties:
                        share_id:
                          type: string
                          format: uuid
                        user_id:
                          type: string
                          nullable: true
                        group_id:
                          type: string
                          nullable: true
                        permission:
                          type: string
                        shared_at:
                          type: string
                          format: date-time
                        revoked_at:
                          type: string
                          format: date-time
                          nullable: true
                        shared_by:
                          type: string
                          description: Email of user who granted access
        '403':
          description: Not scheme owner
        '404':
          description: Scheme not found

  /schemes/shared-with-me:
    get:
      summary: List schemes shared with current user
      operationId: listSharedSchemes
      tags:
        - Marking Schemes - Sharing (Web Only)
      parameters:
        - name: permission_filter
          in: query
          schema:
            type: array
            items:
              type: string
              enum:
                - VIEW_ONLY
                - EDITABLE
                - COPY
          description: Filter by permission level
      responses:
        '200':
          description: List of shared schemes
          content:
            application/json:
              schema:
                type: object
                properties:
                  schemes:
                    type: array
                    items:
                      type: object
                      properties:
                        scheme_id:
                          type: string
                          format: uuid
                        name:
                          type: string
                        owner:
                          type: string
                          description: Email of owner
                        permission:
                          type: string
                        shared_at:
                          type: string
                          format: date-time
                        shared_by:
                          type: string
                          description: Email of user who shared
                        criteria_count:
                          type: integer

components:
  schemas:
    Error:
      type: object
      properties:
        error_code:
          type: string
        message:
          type: string
        timestamp:
          type: string
          format: date-time

    ConversionResult:
      type: object
      properties:
        extracted_scheme:
          type: object
          description: Extracted MarkingScheme JSON
        uncertainty_flags:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              confidence:
                type: number
              reason:
                type: string
        conversion_time_ms:
          type: integer

    ConversionError:
      type: object
      properties:
        error_code:
          type: string
          enum:
            - INVALID_FORMAT
            - UNSUPPORTED_TYPE
            - LLM_FAILURE
            - PARSING_ERROR
            - TIMEOUT
        message:
          type: string
        retry_after_seconds:
          type: integer
          description: If transient error, when to retry

  securitySchemes:
    FlaskSession:
      type: apiKey
      in: cookie
      name: session
      description: Flask session cookie for authentication

security:
  - FlaskSession: []

tags:
  - name: Marking Schemes - Save/Load
    description: Export and import marking schemes as JSON files
  - name: Marking Schemes - Document Conversion
    description: Upload and convert document-based rubrics
  - name: Marking Schemes - Sharing (Web Only)
    description: Share schemes with users and groups (web version only)
